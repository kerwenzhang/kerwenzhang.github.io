---                
layout: post                
title: "FTBatch Equipment Editor User Manual"                
date:   2025-6-27 17:30:00                 
categories: "FTBatch"                
catalog: true                
tags:                 
    - FTBatch                
---      

使用 FactoryTalk Batch 设备编辑器创建和维护设备数据库。区域模型(Area Model)是批量生产设施的物理组件，该数据库包含设施中的所有设备及其能够执行的所有任务。区域模型(Area Model)存储在扩展名为 .cfg 的文件中，可供所有其他 FactoryTalk Batch 程序使用，包括 FactoryTalk Batch 配方编辑器、FactoryTalk Batch 视图和阶段模拟器。  

例如，在配方配置期间，区域模型(Area Model)会提供可用单元和阶段的列表。在后续的配方验证过程中，它会验证指定设备是否能够执行相关程序。在配方执行期间，资源仲裁功能会使用区域模型(Area Model)根据配方和操作员请求分配设备。  

仲裁是一种协调控制方式，用于确定当资源请求数量超过其同一时间可容纳的数量时，资源应如何分配。    

根据 ISA S88.01 批量控制标准的概述，工厂区域模型(Area Model)按以下模型组件组织：  
- 工艺单元（Process Cell）  
- 设备单元（Unit）  
- 阶段（Phase）  
- 控制模块（Control Module）  

除创建区域模型(Area Model)外，FactoryTalk Batch 设备编辑器还可：  
- 定义电子签名和配方审批签核的签名模板。  
- 配置配方审批的步骤和签核环节。  
- 启用配方版本控制。  
- 使用安全权限保护区域模型(Area Model)。  
- 指定服务器通信功能。  
- 指定 FactoryTalk 事件归档器筛选器和报告选项。  


### 区域模型(Area Model)Area Model  

区域模型(Area Model)定义了与FactoryTalk Batch服务器交互的制造设施能力。设施信息存储在通过FactoryTalk Batch设备编辑器构建的配置文件中，并保存为.cfg扩展名的文件（如SouthPlant.cfg）。  

区域模型(Area Model)包含用于创建批次的工艺设备信息，包括为特定物理工厂某一区域配置的所有设备。一个区域模型(Area Model)对应单个FactoryTalk Batch服务器，其配置文件（.cfg）可供FactoryTalk Batch配方编辑器、FactoryTalk Batch服务器和阶段模拟器使用。  

**创建区域模型(Area Model)的顺序**：  
- 枚举（Enumerations）  
- 数据服务器（Data servers）  
- 资源（Resources）  
- 工艺单元（Process cells）  
- 设备单元（Units）  
- 阶段类（Phase classes）  
- 阶段（Phases）  

在某些情况下，定义下层设备后需要重新配置上层设备。  


#### 运行时区域模型(Area Model)  
区域模型(Area Model)配置完成后即可上线，并在运行时用于生产批次。若运行时需要修改区域模型(Area Model)，可修改在线区域模型(Area Model)，然后将其部署到运行时区域模型(Area Model)以响应更新需求。  

区域模型(Area Model)配置由一组定义区域功能的元素组成，其中部分元素在模型运行时不可更改。修改区域模型(Area Model)后，必须对照运行时区域模型(Area Model)验证，确认允许更新已修改的元素。验证通过后，可将更改部署到运行时区域模型(Area Model)。  



#### 创建区域模型(Area Model)  
某些FactoryTalk Batch模块使用区域模型(Area Model)名称来标识与之关联的FactoryTalk Batch系统数据。  

**创建区域模型(Area Model)步骤**：  
1. 选择 **开始 > Rockwell Software > 设备编辑器**。  
2. 选择 **文件 > 新建**，打开空白区域模型(Area Model)。  
3. 选择 **编辑区域（ ）**，打开“编辑区域”对话框。  
4. 在“名称”中输入区域的唯一名称。  
5. 在“版本”中输入版本号。  
6. 选择 **确定** 返回设计视图区域，区域名称将显示在设计视图标题栏中。  
7. 选择 **文件 > 保存**。  
8. 输入合适的文件名，然后选择 **保存** 保存区域模型(Area Model)。  

区域模型(Area Model)将保存到配置文件中，可随时打开修改。  

**重要事项**：重启FactoryTalk Batch服务器以应用更改，并重新验证所有基于修改后区域模型(Area Model)运行的配方。  


#### 打开区域模型(Area Model)  
**打开区域模型(Area Model)步骤**：  
1. 选择 **开始 > Rockwell Software > 设备编辑器**。  
2. 选择 **文件 > 打开**。  
3. 定位并选择区域模型(Area Model)文件（.cfg），然后选择 **打开**。  


#### 区域模型(Area Model)与FactoryTalk Batch物料管理器(Material Manager)  
当FactoryTalk Batch与物料管理器结合使用时，区域模型(Area Model)与物料数据库存在依赖关系。打开区域模型(Area Model)时，MATERIALS和CONTAINERS枚举集会基于物料数据库中的物料和容器重新创建。若物料服务器不可用，枚举集将仅包含默认值（NULL_MATERIAL和NULL_CONTAINER）。  

#### 验证和部署区域模型(Area Model)  
为准备部署区域模型(Area Model)，操作员可验证对模型所做的更改是否允许，然后将更改部署到运行时区域模型(Area Model)。  

**使用FactoryTalk Batch设备编辑器验证区域模型(Area Model)步骤**：  
1. 选择 **开始 > Rockwell Software > 设备编辑器**。  
2. 选择 **文件 > 打开**。  
3. 定位并选择要验证的区域模型(Area Model)文件（.cfg），然后选择 **打开**。  
4. 选择 **文件 > 验证/部署...**。  
5. 在“验证/部署区域模型(Area Model)”对话框中，查看信息并选择 **验证区域模型(Area Model)**，将原始区域模型(Area Model)与更改后的模型进行比较。  
6. 若验证失败，将显示消息，选择 **查看日志** 查看不允许的差异原因。  
7. 选择 **关闭**。  

**使用FactoryTalk Batch设备编辑器部署区域模型(Area Model)步骤**：  
1. 选择 **开始 > Rockwell Software > 设备编辑器**。  
2. 选择 **文件 > 打开**。  
3. 定位并选择要部署的区域模型(Area Model)文件（.cfg），然后选择 **打开**。  
4. 选择 **文件 > 验证/部署...**。  
5. 在“验证/部署区域模型(Area Model)”对话框中，选择 **部署区域模型(Area Model)**。  
   - 状态区域将显示是否允许部署。若失败，将显示消息，选择 **查看日志** 查看详细信息。  
   - **提示**：若操作员无FactoryTalk权限，“部署区域模型(Area Model)”按钮将禁用。  
6. 选择 **关闭**。  



### 区域模型的导入与导出
FactoryTalk Batch 支持导入 XML 格式的区域模型，也能将区域模型导出为 XML 格式。XML 作为一种标准的非专有格式，十分适合用于发布区域模型配置。

### XML 区域模型
在提供中立信息实现方面，XML 模式和 XML 实例文档已成为行业标准。借助 FactoryTalk Batch，用户可通过 FactoryTalk Batch 设备编辑器导入或导出 XML 格式的区域模型。这一功能使得企业间能以标准的非专有 XML 格式交换区域模型信息，而且该区域模型信息还能使用文本编辑器或 XML 编辑器进行编辑。

**提示**：当把某个区域模型关联到安全权限标识符时，“导出”命令会被禁用，此时该区域模型无法导出。

### 导入 XML 区域模型
导入 XML 区域模型时，FactoryTalk Batch 设备编辑器会在内存中构建该区域模型。用户可将导入的区域模型保存为专有二进制文件，也可将其导出到其他文本文件。

FactoryTalk Batch 设备编辑器会对 XML 文件提供的信息进行验证，只有格式规范且经过验证的 XML 文件才能被导入。要成功导入，XML 文件的扩展名必须为 .axml。FactoryTalk Batch 设备编辑器仅会将具有正确文件扩展名的文件当作 XML 文件来读取。

对于扩展名不是 .axml 的文件，系统会将其作为制表符分隔文件来读取。尽管制表符分隔文本文件通常期望的文件扩展名为 .txt，但 FactoryTalk Batch 设备编辑器会把所有扩展名不是 .axml 的文件都尝试作为制表符分隔文本文件来读取。

**提示**：每次创建、打开或导入新的区域模型时，YES_NO、MATERIALS、MATERIAL_CLASSES 和 CONTAINERS 枚举集都会重新创建，已有的值不会被导入。若材料服务器不可用，MATERIALS、MATERIAL_CLASSES 和 CONTAINERS 枚举集将仅使用 NULL_MATERIAL、NULL_CLASS 和 NULL_CONTAINER 默认值创建。（更多信息请参见“导入枚举”）

### 导入 XML 区域模型的步骤
1. 依次选择“开始”>“Rockwell Software”>“设备编辑器”。
2. 选择“文件”>“导入”。
3. 在“文件类型”列表里，选择“XML 文件 (*.axml)”。
4. 找到并选择要导入的 XML 文件。
5. 选择“打开”来启动导入过程，此时会弹出一个消息框，显示每个已导入并验证的组件名称。
6. 选择“确定”完成导入过程，返回 FactoryTalk Batch 设备编辑器。
7. 选择“文件”>“另存为”，保存新导入的文件。此时会打开“另存为”对话框，文件名框中会高亮显示“无标题.cfg”。
8. 在“文件名”中输入新的文件名。若想覆盖当前文件，可使用与当前所选区域模型相同的名称。
9. 选择“保存”，新的区域模型将被保存，并且文件名会显示在 FactoryTalk Batch 设备编辑器的标题栏上。

**提示**：若文件名与“服务器选项”对话框中当前所选的区域模型名称不同，在使用新区域模型之前，需更改“服务器选项”设置。

### 导入枚举
在 FactoryTalk Batch 设备编辑器中，可创建并维护以下系统枚举集：
- PHASE_FAILURES
- YES_NO
- REPORTING_CONTEXTS
- MATERIALS（需安装材料服务器）
- MATERIAL_CLASSES（需安装材料服务器）
- CONTAINERS（需安装材料服务器）

除了 PHASE_FAILURES 和 REPORTING_CONTEXTS，这些由系统维护的枚举集的数据类型或成员不能更改。XML 文件必须包含这些系统枚举集，以便根据架构进行验证，不过这些系统枚举集无法导入。

**提示**：PHASE_FAILURES 和 REPORTING_CONTEXTS 系统枚举集可与这些枚举集中的任何用户定义枚举一起导入。

### 导入系统阶段类(Phase Class)
FactoryTalk Batch 设备编辑器会创建并维护以下系统阶段类(Phase Class)集：
- $NULL
- $TIMER

在导入系统阶段类(Phase Class)时，会对整个阶段类(Phase Class)进行验证，只有完全匹配的阶段类(Phase Class)才会被导入。

**提示**：若任何系统阶段类(Phase Class)（$TIMER 或 $NULL）存在错误，仅会显示第一个错误。

### $NULL 阶段
$NULL 阶段类的验证规则如下：
- 阶段类名称必须为 $NULL。
- 不能配置配方或报告参数。
- 不能配置消息。
- 不能配置控制策略。
- 不能配置请求参数。
- 不能配置消息伙伴。
- 所有其他可配置值均未设置。

### $TIMER 阶段
$TIMER 阶段类的验证规则如下：
- 阶段类名称必须为 $TIMER_X（其中 X 为计时器类型和度量单位，例如 $TIMER_DN_SECOND 或 $TIMER_UP_DAY）。
- 不能配置消息。
- 不能配置控制策略。
- 不能配置请求参数。
- 不能配置消息伙伴。

### 将区域模型导出为 XML
FactoryTalk Batch 支持将区域模型导出为格式规范的 XML 格式。除了 PHASE_FAILURES 和 REPORTING_CONTEXTS，系统维护的枚举集的数据类型或成员不能更改。XML 文件必须包含这些系统枚举集，以便根据架构进行验证。这些系统枚举集可以导出，但不能导入。

所有系统阶段（$NULL 或 $TIMER）都会被导出。所有关联的配方和报告参数以及关联数据（对于 $TIMER_X 阶段）都是导出的一部分（例如，其中 X 是计时器类型和度量单位；$TIMER_DN_SECOND 或 $TIMER_UP_DAY）。

**提示**：
- PHASE_FAILURES 和 REPORTING_CONTEXTS 系统枚举集将与这些枚举集中的任何用户定义枚举一起导出。
- 当区域模型安全到 FactoryTalk 网络目录安全权限标识符时，“导出”命令将被禁用。

### 将区域模型导出为 XML 的步骤
1. 选择“开始”>“Rockwell Software”>“设备编辑器”。
2. 选择“文件”>“打开”以打开区域模型。
3. 选择“文件”>“导出”。此时将打开“文件导出为”对话框。
4. 找到并选择要导出区域模型的文件，或者在“文件名”中键入新的文件名。
5. 在“保存类型”中，选择“XML 文件 (*.axml)”。
6. 选择“保存”以启动导出过程。如果文件已存在，请确认是否替换该文件。
7. 选择“确定”完成导出过程并返回 FactoryTalk Batch 设备编辑器。

### 从命令行将 XML 转换为二进制
可以使用随附的程序 AreaModelConvert.exe 从命令行将 XML 区域模型转换为专有二进制格式。只有格式规范、符合架构且经过程序验证的 XML 文件才能转换。从命令行导出时，请更改为包含 AreaModelConvert.exe 的目录，并且路径不能包含任何空格。UNC 名称也受支持，如下列语法示例所示：命令行的语法为：C:AreaModelConvert.EXE 输入文件 输出文件 日志文件 其中：
- InputFile 指定输入 XML 文件名的路径。
- OutputFile 指定输出二进制文件名的路径。
- LogFile 指定日志文件的路径。

**示例**：C:AreaModelConvert.EXE \Batchctl\SampleDemo1\recipes\ice_cream1.axml \Batchctl\SampleDemo1\recipes\ice_cream1.cfg \Batchctl\SampleDemo1\logs\convert.log

命令行验证 XML 文件中的信息并覆盖 OutputFile 指定的现有文件。错误消息将附加到日志文件中。

**重要提示**：命令行程序不会验证特定于材料的信息，包括：
- 材料服务器的运行状态
- 引用材料的存在性
- 引用材料类的存在性
- 引用容器的存在性

如果命令行参数有效，程序将返回 0（零），表示导入成功。如果命令行参数无效，命令行程序将返回 1（一），表示失败。在日志文件中查看返回代码以检查转换是成功还是失败。


### 脚本化区域模型导入  
区域模型导入工具（Area Model Importer）是一款可脚本化的命令行实用程序，可用于导入新的区域模型或向现有区域模型添加内容。待导入的文件必须为XML区域模型格式。此外，可提供现有区域模型二进制文件（.cfg），以创建合并了两个输入数据的新区域模型二进制文件。  

该工具安装在安装设备编辑器的BATCHCTL\bin目录中。尽管设备编辑器也具备导入XML区域模型的类似功能，但区域模型导入工具是专门设计的“可脚本化”工具。这意味着该工具可从命令行或脚本执行，无任何用户界面，并返回整数值，供脚本用于判断请求的区域模型导入是否成功。区域模型导入工具还会为每次执行生成日志文件，可用于查看额外信息（通常在导入失败时尤为重要）。此外，该工具支持更新现有二进制区域模型。  


#### 完整区域模型导入  
区域模型导入工具可通过输入区域模型XML创建新的二进制区域模型。-Input开关用于指定输入文件路径，-Output开关用于指定要创建的二进制区域模型（.cfg）文件。  
输入的区域模型XML文件需遵循现有区域模型XML架构。“AreaModel.xsd”架构文件可在安装FactoryTalk Batch编辑器时创建的BATCHCTL共享目录的“Schemas”子目录中找到。  


#### 部分区域模型导入  
区域模型导入工具可使用XML文件向现有区域模型添加内容。此过程需要输入现有二进制区域模型文件和部分区域模型XML文件。通过添加-AreaModel开关启用此功能，最终将生成包含两个输入数据的新二进制区域模型文件。  
输入的部分区域模型XML文件需遵循新的XML架构。“PartialAreaModel.xsd”架构文件可在安装FactoryTalk Batch编辑器时创建的BATCHCTL共享目录的“Schemas”子目录中找到。  

可向现有二进制区域模型（.cfg）文件添加以下区域模型对象：  
- 枚举集  
- 枚举  
- 数据服务器  
- 标签类  
- 工艺单元类  
- 单元类  
- 阶段类  
- 操作序列类  
- 工艺单元实例  
- 单元实例  
- 阶段实例  
- 操作序列实例  

部分区域模型导入要求对其他对象的任何引用必须在输入XML或现有区域模型中定义。为确保所有引用有效，导入逻辑将检查冲突对象。若输入区域模型XML中定义的重复对象必须与现有二进制区域模型文件中定义的对象匹配。  
检测到重复不匹配对象时，将输出描述冲突的错误消息。例如：  
**现有“TEST_PHASE”配方阶段与XML配方阶段冲突！以下数据不匹配：**  
- 阶段参数“P_REAL”的可缩放属性  
- 阶段参数“P_REAL”的数值类型  
- 阶段参数“P_REAL”的下载标志  


#### FactoryTalk安全集成  
区域模型导入工具利用FactoryTalk安全单点登录功能确定执行工具的用户。此外，可指定命令行开关（-UserName和-Password）强制区域模型导入工具以指定用户身份运行。  
执行区域模型导入工具的用户必须具备与使用设备编辑器创建/编辑区域模型的用户相同的权限。具体而言，工具会检查用户对FactoryTalk目录中“Batch/Equipment Editor>AccessModes>FullEdit” FTSecurity策略的访问权限，以确定用户是否允许导入区域模型。  


#### FactoryTalk目录锁定  
在部分区域模型导入期间，将检查现有区域模型二进制文件的安全权限标识符（SAI）。SAI要求规定：锁定到特定FactoryTalk目录的区域模型不得由未在指定FactoryTalk目录上运行的任何应用程序打开。区域模型导入工具必须打开现有区域模型以执行部分导入。在此情况下，工具将检查区域模型是否包含SAI：  
- 若区域模型包含SAI，工具将检查指定的SAI是否与当前FTSP SAI匹配。若不匹配，工具将返回错误消息和代码，表明无法执行部分区域模型导入。  


#### 日志记录  
每次调用时，区域模型导入工具会生成唯一的日志文件，记录区域模型导入尝试的结果；若导入失败，还会记录失败原因。每个日志文件的唯一名称格式如下：  
**AreaModelImportLog_<月>_<日>_<年>_<时>_<分>_<秒>_<毫秒>.log**  
其中：  
- <月>：两位整数（01..12）  
- <日>：两位整数（01..31）  
- <年>：四位整数（0000..9999）  
- <时>：两位整数（00..23）  
- <分>：两位整数（00..59）  
- <秒>：两位整数（00..59）  
- <毫秒>：三位整数（000..999）  

**示例**：AreaModelImportLog_10_09_2023_08_52_06_096.log  

区域模型导入工具的日志文件包含两个部分：  
1. **头部块**：记录导入工具执行的关键信息。  
2. **主体块**：记录进度/状态消息。若日志文件达到最大大小（9,999,999字节），主体块将作为循环缓冲区，新日志条目覆盖最旧的条目。  

调用AreaModelImporter.exe工具时，可使用-Verbosity开关控制日志详细程度。支持的详细程度设置（优先级由低到高）为：INFO、WARN、SEVERE。若未指定详细程度，工具将按INFO级别执行。详细程度设置用于控制写入日志文件主体块的记录——仅写入优先级大于或等于指定级别的记录，且不影响头部块的记录。  

日志文件的写入目录由调用工具时的-LogPath开关控制。若未指定-LogPath开关，日志将写入当前工作目录。  


#### 区域模型导入工具程序详情  
区域模型导入工具是名为AreaModelImporter.exe的Windows命令行应用程序，可在安装FactoryTalk Batch编辑器时创建的BATCHCTL共享目录的bin子目录中找到。  


#### 语法-区域模型  
调用区域模型导入工具的语法如下：  
**AreamodelImporter.exe [<参数>]**  
若未指定参数或参数无效，将生成文本输出，说明支持的程序参数。  

区域模型导入工具支持以下参数：  


| **参数**                | **描述**                                                                                                                                                                                                                                                                                                                                 |
|-------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| -Input <文件路径名>      | 指定导入指定区域模型XML文件的请求。文件名可为完整文件路径；若未包含路径信息，默认文件位于当前工作目录。文件名必须以FTBatch认可的XML区域模型文件扩展名“.axml”结尾（不区分大小写）。<br>- 若指定-AreaModel开关，XML文件必须符合PartialAreaModel.xsd架构；<br>- 若未指定-AreaModel开关，XML文件必须符合AreaModel.xsd架构。 |
| -Output <文件路径名>     | 指定在提供的文件路径创建二进制区域模型文件的请求。                                                                                                                                                                                                                     |
| -Overwrite              | 指定允许导入覆盖与指定输出匹配的现有二进制区域模型文件。若未指定此参数，若导入的区域模型与现有区域模型名称冲突，将拒绝导入。                                                                                                                                                                                                                                                       |
| -Username <用户名>       | 指定用于检查访问权限的用户名（可选）。若提供此参数，必须同时提供-Password开关。                                                                                                                                                                                                                                                     |
| -Password <密码>         | 指定用于检查访问权限的密码（可选）。若提供此参数，必须同时提供-Username开关。                                                                                                                                                                                                                                                       |
| -Verbosity <值>         | 指定设置区域模型导入工具的日志详细程度级别。支持的详细程度值（优先级由低到高）为INFO、WARN、SEVERE。工具仅向日志主体块写入优先级大于或等于指定级别的记录。若未指定，默认按INFO级别执行。头部块的记录不受详细程度设置影响，始终写入。                                                                 |
| -LogPath <目录路径>      | 指定导入工具写入生成的日志文件的目录。若未指定，日志将写入当前工作目录（即调用工具的目录）。                                                                                                                                                                                                                                   |
| -AreaModel <文件路径名>  | 指定现有二进制区域模型的路径作为输入，激活工具的部分区域模型导入功能。                                                                                                                                                                                                                                                             |


**示例1：覆盖目标文件的完整区域模型导入命令行参数**  
AreaModelImporter.exe -Input "ice_cream1.axml" -Output "ice_cream1.cfg" -Overwrite  

**示例2：向现有区域模型二进制文件导入部分区域模型XML的命令行参数**  
AreaModelImporter.exe -Input "new_units.axml" -Output "updated_ice_cream1.cfg" -AreaModel "ice_cream1.cfg"  


#### 控制台文本输出  
区域模型导入工具在执行期间生成控制台文本输出，记录区域模型导入过程中的进度和问题。大部分控制台输出文本会记录在每次执行生成的唯一日志文件中。  


#### 退出返回代码  
AreaModelImporter.exe工具返回整数错误结果代码，通用错误代码定义如下：  


| **通用错误代码** | **描述**                                                                                                                                                                                                                                                                                                                                 |
|------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 0                | 成功：请求的区域模型导入成功。                                                                                                                                                                                                                                                                                                         |
| 1                | 参数无效：命令行参数无效。                                                                                                                                                                                                                                                                                                             |
| 2                | 文件扩展名无效：使用-Input开关指定的文件名扩展名非有效（.axml），或-Output开关指定的扩展名非有效（.cfg）。                                                                                                                                                                                                                         |
| 3                | 文件未找到：使用-Input开关指定的输入路径不存在。                                                                                                                                                                                                                                                                                       |
| 4                | 不允许覆盖：导入的区域模型将覆盖输出路径中的现有区域模型，且未指定-Overwrite开关，拒绝导入。                                                                                                                                                                                                                                   |
| 5                | 文件权限：由于文件权限问题，无法打开/读取使用-Input或-Output开关指定的文件。                                                                                                                                                                                                                                                         |
| 6                | 内部错误：发生内部错误。                                                                                                                                                                                                                                                                                                               |
| 7                | 保留。                                                                                                                                                                                                                                                                                                                                 |
| 8                | XML解析失败：解析区域模型XML时失败。                                                                                                                                                                                                                                                                                                   |
| 9                | XML架构失败：区域模型XML不符合所需架构。                                                                                                                                                                                                                                                                                               |
| 10               | 用户身份验证失败：无法验证用户身份。                                                                                                                                                                                                                                                                                                   |
| 11               | 访问被拒绝：用户无权创建区域模型。                                                                                                                                                                                                                                                                                                     |
| 12               | 日志初始化错误：尝试初始化日志时出错。                                                                                                                                                                                                                                                                                               |
| 13               | 日志路径无效：指定的日志目录无效。                                                                                                                                                                                                                                                                                                     |
| 14               | -AreaModel开关指向的区域模型二进制文件无法打开。                                                                                                                                                                                                                                                                                       |
| 15               | FactoryTalk网络目录与现有区域模型所需的SAI不匹配。                                                                                                                                                                                                                                                                                   |


### 枚举概述  
枚举是定义为变量数据类型的系统对象，由数值（称为**序数值**）和关联文本字符串组成。过程连接设备（PCD）与FactoryTalk Batch服务器通过序数值通信，服务器随后向操作员显示与序数值关联的文本字符串。使用枚举可向操作员显示有意义的文本，而非数字。  

枚举集包含相关枚举的分组。FactoryTalk Batch和PCD会创建并维护以下默认系统枚举集：  
- PHASE_FAILURES（阶段故障）  
- YES_NO（是/否）  
- MATERIALS（适用于安装材料服务器的系统）  
- MATERIAL_CLASSES（适用于安装材料服务器的系统）  
- CONTAINERS（适用于安装材料服务器的系统）  
- REPORTING_CONTEXTS（报告上下文）  

由系统维护的YES_NO、MATERIALS、MATERIAL_CLASSES或CONTAINERS枚举集的数据类型和成员不可更改。可在区域模型内创建自定义枚举和枚举集。  

**示例**：负数序数的使用  
预混器B（单元#2）中的搅拌器可能使用：  
- 枚举集名称：MOTORS  
- 枚举名称 | 序数 | 字符串  
  - Enumeration_1 | 0 | OFF（关闭）  
  - Enumeration_2 | 1 | FORWARD（正向）  
  - Enumeration_3 | -1* | REVERSE（反向）  


#### 系统枚举集  
存在五个默认系统枚举集。除PHASE_FAILURES和REPORTING_CONTEXTS枚举集外，这些系统维护的枚举集的数据类型或成员不允许更改。  


| **系统枚举集**       | **用途**                                                                                                                                                                                                                                                                                                                                 |
|----------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| PHASE_FAILURES       | 默认情况下，此枚举集不含成员。可根据具体实施需求添加枚举。<br>**重要提示**：PHASE_FAILURES枚举的序数值不能大于32767或小于0（零）。                                                                                                                                                                                                                                                         |
| REPORTING_CONTEXTS   | 此枚举集支持向阶段类参数和报告添加报告上下文字符串，便于查询和排序与集合相关的事件。可添加、删除和编辑此枚举集的成员。默认枚举为NULL，序数值为0。                                                                                                                                                                                                                                           |
| YES_NO               | 简单枚举集，包含两个成员：NO（序数值0）和YES（序数值1），不可修改。                                                                                                                                                                                                                                                                                                                                 |
| MATERIALS（安装材料服务器） | 表示FactoryTalk Batch材料管理器数据库中配置的材料集合。默认枚举为NULL_MATERIAL，序数值0，允许将枚举分配给MATERIALS类型的参数（实际材料分配将延迟到构建配方时）。每次创建、打开或导入区域模型时，其他枚举集成员将基于材料数据库中的材料数据重新创建。材料的控制器ID范围为1到9999999999。                                                                                     |
| CONTAINERS（安装材料服务器） | 表示FactoryTalk Batch材料管理器数据库中配置的容器集合。默认枚举为NULL_CONTAINER，序数值0。每次创建、打开或导入区域模型时，其他枚举集成员将基于材料数据库中的容器数据重新创建。容器的控制器ID范围为1到9999999999。<br>若FactoryTalk Batch材料管理器数据库不可用，MATERIALS和CONTAINERS枚举集仅包含默认枚举。<br>材料和容器的控制器ID即枚举的序数值。若修改材料数据库中的控制器ID，关联枚举的序数值将变更，可能影响阶段逻辑。                                                                 |

**说明**：PHASE_FAILURES和REPORTING_CONTEXTS是唯一可添加枚举的系统枚举集。系统枚举集以粗体显示，与自定义枚举集区分。  


#### 创建枚举集  
**操作步骤**：  
1. 选择“开始”>“Rockwell Software”>“设备编辑器”。  
2. 选择“编辑”>“枚举集”，打开“创建枚举集和枚举”对话框。  
3. 在“集合”下，选择“新建”。  
4. 在“创建枚举集”对话框中，输入新枚举集名称，选择“确定”返回“创建枚举集和枚举”对话框。新枚举集名称将显示在“枚举集”列中。  
   **提示**：若未向新枚举集添加成员，在更新阶段类参数和报告时，该集合不会作为选项显示在“Enum/E.U.”列表中。  


#### 添加枚举成员  
**操作步骤**：  
1. 选择“开始”>“Rockwell Software”>“设备编辑器”。  
2. 选择“编辑”>“枚举集”，打开“创建枚举集和枚举”对话框。  
3. 选择目标枚举集。  
4. 在“枚举”下，选择“新建”。  
   **提示**：不可向YES_NO、MATERIALS、MATERIAL_CLASSES和CONTAINERS系统枚举集添加成员。  
5. 输入枚举名称和序数值，或接受默认序数值。  
   **重要提示**：PHASE_FAILURES枚举仅支持0到32767的正序数值。  
6. 选择“确定”返回对话框，新枚举名称将显示在“枚举”下。  


#### 编辑枚举和枚举集  
**操作步骤**：  
1. 选择“开始”>“Rockwell Software”>“设备编辑器”。  
2. 选择“编辑”>“枚举集”，打开“创建枚举集和枚举”对话框。  
3. 选择要编辑的枚举集或枚举。  
4. 选择对应的“编辑”按钮（集合或枚举）。  
5. 若编辑枚举，输入新枚举名称。  
   **重要提示**：PHASE_FAILURES枚举仅支持0到32767的正序数值。  
6. 若编辑未分配的枚举集，将显示“编辑枚举集名称”对话框，输入新名称后选择“确定”返回。  
   若编辑已分配的枚举集，将显示警告并列出使用该枚举的项目：  
   - 选择“是”编辑名称，列表中的项目将更新为新名称；选择“否”取消修改。  
7. 选择“确定”返回对话框。  


#### 删除枚举和枚举集  
**操作步骤**：  
1. 选择“开始”>“Rockwell Software”>“设备编辑器”。  
2. 选择“编辑”>“枚举集”，打开“创建枚举集和枚举”对话框。  
3. 选择要删除的枚举集或枚举。  
4. 选择“删除”：  
   - 若删除枚举，继续步骤5；若删除枚举集，跳至步骤6。  
5. **删除枚举**：  
   - 若枚举非阶段类(Phase Class)参数的默认值，将显示确认删除的警告，选择“是”删除，“否”取消。  
   - 若枚举是阶段类(Phase Class)参数的默认值且选择“是”，将显示提示无法删除，并列出使用该枚举的参数名称。需先修改阶段类(Phase Class)参数以移除默认枚举，再选择“确定”关闭警告。  
6. **删除枚举集**：  
   **提示**：使用已删除枚举集的项目将默认设置为“类型=整数”和“工程单位=工程单位”。  
   - 显示确认删除的警告，选择“是”删除，“否”取消。  
   - 显示已分配项目的列表：  
     - 选择“是”删除，将显示受影响的标签、参数和报告数量，选择“确定”返回。  
     - 选择“否”取消删除；选择“关闭”返回设计视图。


### FactoryTalk Batch的参数与报告  
FactoryTalk Batch服务器使用**参数**将值发送至过程连接设备（PCD），而**报告**则将值从PCD返回至服务器。通过FactoryTalk Batch设备编辑器可为阶段配置参数和报告，阶段实例会继承其创建所基于的阶段类(Phase Class)的参数和报告。  


#### 配方中的参数与报告  
使用FactoryTalk Batch配方编辑器将阶段类(Phase Class)添加到操作级配方时，阶段类(Phase Class)参数为公式值，阶段类(Phase Class)报告为报告值。定义公式值时，配方设计者可选择：  
- 接受默认公式值（即对应阶段类(Phase Class)参数的默认值）。  
- 分配新值。  
- 将公式值分配延迟至操作员或配方公式参数（仅与配方关联的参数）。  

使用参数可减少所需的阶段类(Phase Class)或配方数量。  

**参数示例**：  
若工厂有一个混合多种产品的单元，可定义一个阶段类(Phase Class)来表示混合单元中搅拌器的速度。要么为每种所需速度定义不同的阶段类(Phase Class)，要么定义一个阶段类(Phase Class)并为搅拌器速度配置参数。在配方中使用该阶段类(Phase Class)时，可立即或延迟分配值。通过延迟值分配，可创建一个用于多个配方的操作。  


#### 参数、报告与阶段标签  
阶段是区域模型中阶段类(Phase Class)的实例，使用**标签**与过程连接设备（PCD）中的工程逻辑通信。阶段中的每个标签映射到PCD中的特定内存地址或标签，用于在配方执行期间存储与阶段相关的数据。FactoryTalk Batch服务器和PCD使用这些标签交换阶段信息。  

**提示**：FactoryTalk Linx FactoryTalk Live Data标签的配置与OPC标签相同。  
每个OPC阶段至少有十个标准标签。配置OPC阶段所基于的阶段类(Phase Class)时，需定义参数和报告通信所需的标签数量，以及额外的请求标签。  

**提示**：对于分配给Logix5000 CIP数据服务器的PhaseManager阶段，无需定义参数、报告和请求标签的数量。当区域模型与Logix Designer项目同步时，会自动配置正确数量的标签。  


#### 阶段标签概述  
**请求标签**是与每个OPC阶段关联的十个标准标签之一，PCD使用该标签向FactoryTalk Batch服务器请求服务。有时PCD需要传递更多信息，此时可在阶段类(Phase Class)上指定OPC阶段所需的额外请求标签数量。  

**提示**：对于分配给Logix5000 CIP数据服务器的PhaseManager阶段，无需配置请求标签。当区域模型与Logix Designer项目同步时，会自动为Logix5000 CIP阶段创建标签。  

OPC阶段的阶段类(Phase Class)参数和报告数量可与参数和报告标签数量不同。部分OPC阶段逻辑程序可能不希望参数数量与参数标签数量匹配，或报告数量与报告标签数量匹配。  

若要使阶段类(Phase Class)的参数和报告数量始终等于关联阶段的参数标签和报告标签数量，需在阶段类(Phase Class)上启用**参数/标签锁定**。若禁用参数/标签锁定，需在阶段类(Phase Class)上指定关联OPC阶段存在的参数和报告标签数量，该数量可与OPC阶段定义的阶段类(Phase Class)参数和报告数量不同。  

**提示**：对于Logix5000 CIP阶段，无论选择何种设置，参数/标签锁定始终启用。当区域模型与Logix Designer项目文件同步时，FactoryTalk Batch设备编辑器创建的参数标签数量与阶段类(Phase Class)的参数数量相同，报告标签数量与阶段类(Phase Class)的报告数量相同。  

总结：创建阶段时，需指定：  
- 与阶段类(Phase Class)关联的参数和报告数量。  
- 阶段中与这些参数、报告和额外请求关联的标签数量（启用参数/标签锁定或指定实际标签数量）。  

**提示**：FactoryTalk Linx FactoryTalk Live Data标签的配置与OPC标签相同。  
创建OPC阶段实例（分配OPC数据服务器的阶段）时，需指定：  
- PCD中与十个标准标签关联的内存地址或标签。  
- PCD中与任何已配置参数、报告和额外请求标签关联的内存地址或标签。  

**提示**：若阶段标签数量与指定阶段类(Phase Class)的参数数量不相等（阶段标签数量应等于最高参数ID号），上传/下载功能将无法正常工作。此外，为正确传递参数值，阶段逻辑必须使用请求数据参数指定FactoryTalk Batch上传参数的方式。  


#### 阶段标签  
检查过程连接设备（PCD）的配置，验证为OPC阶段配置的标签数量是否与PCD中的标签数量相等。FactoryTalk Batch设备编辑器中定义的参数和报告数据类型必须与PCD中对应的标签数据类型兼容。  

**提示**：FactoryTalk Linx FactoryTalk Live Data标签的配置与OPC标签相同。  


| **FactoryTalk Batch设备编辑器数据类型** | **兼容的PCD数据类型**       |
|--------------------------------------|---------------------------|
| Real（实数）                         | Real（实数）               |
| Integer（整数）                      | Real（实数）、Integer（整数）|
| Enumeration（枚举）                  | Real（实数）、Integer（整数）|
| String（字符串）                     | String（字符串）           |


#### Batch参数Parameters与报告reports  
参数将值从FactoryTalk Batch服务器传递至过程连接设备（PCD），PCD使用报告将值返回至服务器。  

**重要提示**：请勿将以下词语或短语用作参数名称或报告名称：  
- all  
- length  
- recipepath  
- outerhtml  
- finalinstructions  
- stepindex  
- submitstring  
- submit  
使用这些短语作为参数或报告名称可能导致手动阶段控制期间出现错误。  


#### 阶段类(Phase Class)参数  
阶段类(Phase Class)参数在配方阶段执行期间从FactoryTalk Batch服务器传递至阶段逻辑，通常对应阶段标签（映射到PCD中实际配置的参数地址）。  

配置阶段类(Phase Class)时需定义阶段类(Phase Class)参数；配置OPC阶段时需定义对应的参数标签，包括其在PCD中的地址或标签。  

**提示**：对于分配给Logix5000 CIP数据服务器的PhaseManager阶段，当区域模型与Logix Designer项目同步时，会自动创建参数标签，无需手动定义。  


#### 阶段类(Phase Class)报告Report  
阶段类(Phase Class)报告值从过程连接设备（PCD）传递至FactoryTalk Batch服务器，包含指示阶段功能的数据。这些数据存在于运行批次的事件日志文件（.evt）和FactoryTalk Batch报告中，通常对应映射到PCD中配置参数的阶段标签。  

**提示**：FactoryTalk Linx FactoryTalk Live Data报告标签的配置与OPC标签相同。  
配置阶段类(Phase Class)时需为阶段定义阶段类(Phase Class)报告；配置OPC阶段时需定义对应的报告标签，包括其在PCD中的地址或标签。  

**提示**：对于分配给Logix5000 CIP数据服务器的PhaseManager阶段，当区域模型与Logix Designer项目同步时，会自动创建报告标签，无需手动定义。  


#### 材料参数  
若将FactoryTalk Batch Material Manager与FactoryTalk Batch结合使用，需创建支持材料的阶段类(Phase Class)。支持材料的阶段类(Phase Class)使用系统参数指定配方中使用的材料和数量。  

支持材料的阶段类(Phase Class)关联的默认参数为**MATERIAL**和**AMOUNT**，默认报告参数为**ACTUAL_AMOUNT**和**FEED_COMPLETE**。每个支持材料的阶段类(Phase Class)可分配可选材料参数：**CONTAINER**、**LOT**、**LABEL**和**MATERIAL_CLASS**。MATERIAL、LOT和LABEL参数的值组合形成材料规格。  

材料规格决定批次运行时提取材料或分配材料的容器，始终包含材料名称，并可根据容器类型包含批次名称、标签或两者。  


#### 容器类型  
FactoryTalk Batch Material Manager使用三种容器类型：复合（Composite）、活塞流（Plug-Flow）和托盘（Pallet）。所有三种容器均要求材料规格至少包含材料名称：  
- 复合和活塞流容器支持包含批次名称的材料规格。  
- 托盘容器支持包含批次名称、标签或两者的材料规格。  

若材料规格仅包含材料名称，则三种容器类型均有效；若包含材料名称、批次和标签，则仅托盘容器类型有效。  


#### 默认材料参数  

| **参数**       | **用途**                                                                                                                                                                                                                                                                                                                                 |
|----------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| MATERIAL       | 通常配置为默认值NULL_MATERIAL，实际材料在配方中分配。若为参数分配特定材料，则该阶段类(Phase Class)仅能用于输送该材料。MATERIAL参数、阶段运行所在单元，以及AMOUNT参数的高低值共同决定阶段类(Phase Class)是用于材料添加、分配或两者兼具。                                                                                                                                                                                                                                   |
| FEED_COMPLETE  | 报告材料添加或分配完成。ACTUAL_AMOUNT报告参数记录生产或消耗的实际材料数量。                                                                                                                                                                                                                                                         |
| CONTAINER      | 用于保存批次运行时步骤绑定的容器名称，默认值为NULL_CONTAINER。无法在区域模型或配方中为CONTAINER参数分配值（容器被视为区域模型外的设备）。FactoryTalk Batch服务器或操作员确定步骤绑定的合适容器时，会将绑定的容器名称值分配给该参数。除默认值外，该参数仅在运行时步骤绑定时包含值。                                                                                             |
| MATERIAL_CLASS | 表示材料数据库中配置的材料类集合，默认值为NULL_CLASS。根据是否启用控制策略，仅可修改MATERIAL_CLASS的“默认值”和“启动时下载”属性。                                                                                                                                                                                                                                                             |
| LOT            | 用于细化阶段类(Phase Class)可绑定的材料列表，指定给定材料的离散数量。运行时该参数为空时，FactoryTalk Batch服务器将绑定至容器而不考虑批次。                                                                                                                                                                                                                                                             |
| LABEL          | 表示材料的子批次（分配给特定容器的给定材料批次的离散数量）。在材料添加阶段类(Phase Class)中，标签用于细化阶段类(Phase Class)可绑定的材料列表；在材料分配阶段类(Phase Class)中，标签应用于分配至库存的材料子批次。                                                                                                                                                                                                                     |

**提示**：FactoryTalk Batch设备编辑器中，可选材料参数（除MATERIAL_CLASS外）的值不可编辑。  


#### 缩放参数  
选中**缩放（Scale）** 复选框可将参数设置为在运行时包含该阶段的批次缩放时自动按比例调整。  
**示例**：若包含该阶段类(Phase Class)的批次以200%缩放运行，ADD_AMOUNT值自动增加200%（默认值为50时调整为100）；若批次以50%缩放运行，ADD_AMOUNT调整为25。  


#### 参数偏差验证方法  
当参数或报告值超出区域模型设计者定义的可接受范围时，会发生参数偏差。验证策略为每个参数定义可接受限制集，以及参数或报告值超出限制时的对应操作。**验证方法**是策略中定义参数或报告可接受限制集的部分。向阶段类(Phase Class)添加参数或报告时，可接受默认验证方法（无限制）或选择不同的验证方法。  

**提示**：若验证策略需要电子签名，需在配置验证策略前设置签名模板。  


#### 控制策略概述  
在FactoryTalk Batch设备编辑器中创建适用于特定阶段类(Phase Class)的参数和报告，这些参数和报告直接与阶段类(Phase Class)关联，默认适用于包含该阶段类(Phase Class)的所有配方。但部分阶段类(Phase Class)可能在单个配方中承担不同角色，或在不同配方中承担不同角色，此时仅需阶段类(Phase Class)关联的参数和报告子集，避免配方执行时产生不必要的阶段I/O——**控制策略**可解决此问题。  

控制策略是用户定义的阶段类(Phase Class)参数和报告的分组，可与单个阶段类(Phase Class)关联。将参数和报告组织到不同控制策略中，可使阶段类(Phase Class)承担多种角色而不产生不必要的阶段I/O。  

为阶段类(Phase Class)创建多个控制策略，每个策略包含独立的参数和报告。在阶段类(Phase Class)中，参数和报告可与单个或多个控制策略关联。若参数或报告与多个控制策略关联，可针对每个关联的控制策略独立定义其值范围、工程单位和报告工程单位。  

**提示**：在FactoryTalk Batch配方编辑器中查看启用控制策略的配方阶段类(Phase Class)时，仅显示指定控制策略的参数值。将参数与特定控制策略关联后，配方设计者或操作员在创建、查看和执行特定配方时，无需自行判断哪些阶段类(Phase Class)参数和报告参数适用。  


#### 控制策略示例  
下表展示单个阶段类(Phase Class)的已配置参数、报告和控制策略，说明参数、报告与控制策略的关系。控制策略下方的“X”表示参数或报告与该策略关联。  

| **参数名称**   | **CONTROL_STRATEGY_1** | **CONTROL_STRATEGY_2** | **策略1值** | **策略2值** |
|----------------|------------------------|------------------------|-------------|-------------|
| PARAMETER_A    | X                      |                        | 150         |             |
| PARAMETER_B    | X                      | X                      | 200         | 275         |
| PARAMETER_C    | X                      |                        | 70          |             |
| REPORT_A       | X                      | X                      | 125         | 125         |

**示例**：阶段类(Phase Class)包含三个参数（PARAMETER_A、PARAMETER_B、PARAMETER_C）和一个报告参数（REPORT_A）。如上述表格所示：  
- PARAMETER_A和PARAMETER_C仅与一个控制策略关联。  
- PARAMETER_B和REPORT_A与多个控制策略关联，其中PARAMETER_B为每个策略定义了独立值。  


#### 实施控制策略  
在区域模型中配置阶段类(Phase Class)以启用或禁用控制策略功能。对于启用控制策略功能的阶段类(Phase Class)，需为其配置一个或多个策略，将阶段类(Phase Class)参数和报告分配给每个策略，并配置其范围、值和工程单位。  

使用FactoryTalk Batch配方编辑器创建主配方时，需为配方中每个阶段类(Phase Class)实例指定使用的控制策略。配方执行时，阶段类(Phase Class)仅使用配方创建时指定的控制策略关联的参数。  

同样，在FactoryTalk Batch View或其他客户端程序中查看执行的配方时，启用控制策略的阶段类(Phase Class)仅显示指定的控制策略及与其关联的参数。但与控制策略关联的参数默认值可修改。此外，若使用手动阶段控制执行阶段类(Phase Class)，需在运行前选择使用的控制策略。  

**提示**：配置阶段中的标签和PCD中的阶段逻辑以支持控制策略使用。当PCD请求下载阶段类(Phase Class)参数或上传阶段类(Phase Class)报告时，基于控制策略仅加载相应的阶段类(Phase Class)参数和报告。需将阶段类(Phase Class)和报告参数配置并映射到PCD中的标签。  


#### 参数和报告子集  
使用**下载参数子集**定义启动时下载（DL on Start）和控制转移时下载（DL on TOC）的阶段类(Phase Class)参数子集，提升批次执行效率；使用**上传报告子集**定义终端状态时上传（UL on Terminal State）和控制转移时上传（UL on TOC）的阶段类(Phase Class)报告子集，优化流程。  

**提示**：控制转移指配方中存在同一阶段的两个实例，且由非“<阶段名称>.State = Complete”的配方转移条件分隔。此时转移条件为真时，运行逻辑不会终止。  

可将参数分配给无、一个或两个上传/下载集合。将参数或报告分配给子集后，当发出相应的阶段逻辑请求时，该参数或报告将与子集其他成员一同下载（参数）或上传（报告）。  

**提示**：FactoryTalk Batch服务器处理阶段逻辑请求出错时，会发出145（请求失败）命令值。增强错误处理阶段逻辑协议支持请求值比当前标准请求大10,000的情况。例如，使用增强阶段逻辑请求上传报告参数时，在标准请求代码2200基础上加10,000，得到增强请求代码12200。  

**重要提示**：当FactoryTalk Batch服务器配置为暖启动（Warm）或全暖启动（Warm All）并使用自动上传时，阶段在上传期间转换为外部状态时，服务器可能会两次上传添加的材料信息。请检查日志文件，若发生两次上传，需手动调整材料数据库中的数量。每次暖启动时，数量参数的设定值也会重新计算，可能需要手动更新。  


#### 不同子集的阶段类(Phase Class)  
下表为阶段类(Phase Class)示例，展示其参数和报告如何分配给不同子集：  

| **参数**       | **启动时下载（DL on Start）** | **控制转移时下载（DL on TOC）** | **报告**         | **终端状态时上传（UL on Terminal State）** | **控制转移时上传（UL on TOC）** |
|----------------|------------------------------|--------------------------------|------------------|-------------------------------------------|--------------------------------|
| SPEED          | X                            | X                              | AGITATE_TIME     | X                                         | X                              |
| TIME           | X                            | X                              | AVG_TEMP         | X                                         |                               |
| LEVEL          | X                            |                                | AVG_SPEED        | X                                         | X                              |
| TEMP           | X                            |                                | AMT_DUMPED       | X                                         |                               |


#### 下载参数请求  
下载参数子集用于定义当相应阶段逻辑请求发送至FactoryTalk Batch服务器时，下载至PCD的参数子集：  
- 若选择**启动时下载（DL on Start）**，FactoryTalk Batch服务器会在向阶段发出START命令前将这些参数下载至PCD。下载验证通过后，服务器启动阶段。阶段逻辑可显式请求此操作，或配置阶段使服务器在发出START命令前自动下载这些参数。  
- 若选择**控制转移时下载（DL on TOC）**，控制转移情况发生时，参数将下载至PCD。控制转移指配方中存在同一阶段的两个实例，且由非“<阶段名称>.State = Complete”的转移条件分隔，此时转移条件为真时，阶段的运行逻辑不会终止，阶段逻辑必须显式请求服务器将控制转移参数子集下载至PCD。  

**仅下载分配给DL on Start子集的参数**，使用以下下载请求：  
| **（OPC或FTD）阶段**   | **Logix5000 CIP阶段**               |
|------------------------|-------------------------------------|
| 1501或11501请求        | PXRQ指令，外部请求：下载输入参数子集<br>DINT[0] - 1 |

**仅下载分配给DL on TOC子集的参数**，使用以下下载请求：  
| **（OPC或FTD）阶段**   | **Logix5000 CIP阶段**               |
|------------------------|-------------------------------------|
| 1502或11502请求        | PXRQ指令，外部请求：下载输入参数子集<br>DINT[0] - 2 |

发出上述请求时，每个参数将下载至PCD中与阶段参数标签对应的内存地址或标签。  


#### 上传报告请求  
- 若选择**终端状态时上传（UL on Terminal State）**，阶段逻辑转换为COMPLETE、STOPPED或ABORTED终端状态后，FactoryTalk Batch服务器将从PCD上传此报告子集。阶段逻辑可显式请求服务器上传这些报告，或配置阶段使服务器在阶段逻辑转换为终端状态后自动上传。  
- 若选择**控制转移时上传（UL on TOC）**，控制转移情况发生时，报告将上传至PCD，此时阶段逻辑必须显式请求服务器从PCD上传控制转移报告子集。  

**仅上传分配给UL on Terminal State子集的报告**，使用以下上传请求：  
| **（OPC或FTD）阶段**   | **Logix5000 CIP阶段**               |
|------------------------|-------------------------------------|
| 2501或12501请求        | PXRQ指令，外部请求：上传输出参数子集<br>DINT[0] - 1 |

**仅上传分配给UL on TOC子集的报告**，使用以下上传请求：  
| **（OPC或FTD）阶段**   | **Logix5000 CIP阶段**               |
|------------------------|-------------------------------------|
| 2501或12501请求        | PXRQ指令，外部请求：上传输出参数子集<br>DINT[0] - 2 |


#### 自动上传/下载  
自动上传/下载可缩短批次持续时间并减少阶段逻辑编程量，与下载参数子集和上传报告子集配合使用，使FactoryTalk Batch服务器自动下载启动时下载子集中的参数，或上传终端状态时上传子集中的报告。阶段逻辑可开发为发出这些请求，但非必需。  

使用自动上传/下载可将FactoryTalk Batch服务器配置为：  
- 当启动阶段的所有条件为真时，自动下载启动时下载子集中的参数。  
- 当阶段转换为COMPLETE、STOPPED或ABORTED终端状态时，自动上传终端状态时上传子集中的相应报告值。  

自动上传/下载无需阶段逻辑向FactoryTalk Batch服务器发送启动时下载或终端状态时上传请求。  

**提示**：控制转移时下载参数和控制转移时上传报告并非自动执行，仍需阶段逻辑请求。  

**启动时自动下载参数**和**终端状态时上传**需为每个阶段单独配置（前提是阶段所基于的阶段类(Phase Class)的参数和报告已分组到相应子集）。这两个功能可在阶段上独立配置。对于终端状态时上传，可指定自动功能适用的任何或所有终端状态（COMPLETE、STOPPED或ABORTED）。  

**提示**：FactoryTalk Batch服务器处理阶段逻辑请求出错时，会发出145（请求失败）命令值。增强错误处理阶段逻辑协议支持请求值比当前标准请求大10,000的情况。例如，使用增强阶段逻辑请求上传报告参数时，在标准请求代码2200基础上加10,000，得到增强请求代码12200。  


#### 带参数子集的控制策略  
若参数或报告分配给上传/下载参数子集且启用控制策略，仅上传或下载所有相关子集和所选控制策略的公共参数。  

**示例**：阶段类(Phase Class)包含多个报告和参数，启用控制策略且默认策略为CS1。当发出以下阶段逻辑请求时：  
- 启动时下载：仅包含SPEED、TIME、LEVEL和TEMP参数。  
- 控制转移时下载：仅包含SPEED和TIME参数。  
- 终端状态时上传：仅包含AVG_SPEED、AGITATE_TIME、AVG_TEMP和AMT_DUMPED报告。  
- 控制转移时上传：仅包含AVG_SPEED和AGITATE_TIME报告。  

| **参数**       | **DL on Start** | **DL on TOC** | **CS1** | **报告**         | **UL on Terminal State** | **UL on TOC** | **CS1** |
|----------------|-----------------|---------------|---------|------------------|---------------------------|--------------|---------|
| SPEED          | X               | X             | X       | AVG_SPEED        | X                         | X            | X       |
| TIME           | X               | X             | X       | AGITATE_TIME     | X                         | X            | X       |
| LEVEL          | X               |               | X       | AVG_TEMP         | X                         |              | X       |
| TEMP           | X               |               | X       | AMT_DUMPED       | X                         |              | X       |





### 电子签名  
电子签名是签名及其关联数据的电子表示，包括：  
- 签核含义（如审核、批准、责任或作者身份）  
- 签名者评论  
- 签名者安全要求  
- 签名日期和时间  

FactoryTalk Batch系统中的电子签名可由一、二或三个FactoryTalk用户或组完成签核。  


#### 电子签名类型  
可配置签名以验证以下运行时FactoryTalk Batch事件：  
- 自动和手动（eProcedure）阶段的报告参数。  
- 操作员通过FactoryTalk Batch View或FactoryTalk Batch View HMI控件对配方参数值的更改。  
- eProcedure步骤的完成。  
- 操作员通过FactoryTalk Batch View或FactoryTalk Batch View HMI控件发出的批次或阶段命令。  
- 可配置为在执行自动或手动阶段时随时显示的常规用途。  

电子签名与其对应的电子记录存储在FactoryTalk Batch事件日志中，这些签名包含符合21 CFR第11部分所需的所有组件。  


#### 电子签名工作原理  
配置和执行电子签名的步骤涉及FactoryTalk Batch产品套件：  
1. **FactoryTalk Batch系统管理员**设置电子签名和签核安全性。  
   **重要提示**：不支持在使用FactoryTalk Security配置电子签名后更改FactoryTalk目录服务器，否则可能导致签名签核失败。  
2. 在FactoryTalk Batch设备编辑器中，为签名事件设置FactoryTalk事件归档器的事件筛选器，以便在带Reporting Services的报告或其他报告中使用。  
3. 为区域模型创建签名模板：  
   - 若要获取特定阶段类的配方参数和报告参数的电子签名，需在创建或编辑阶段类时配置验证方法和签名模板。  
   - 若要将所有限制信息下载到阶段逻辑，需将参数标签和报告标签映射到阶段的相应限制标签。  
   - 若要对特定命令的执行要求签名验证，需使用创建的签名模板在FactoryTalk Batch设备编辑器中设置命令验证策略。  

构建主配方时，触发验证策略的配方参数限制默认来自设备阶段指定的参数限制，可在FactoryTalk Batch配方编辑器的配方级别更改这些值。若配置阶段类以获取报告限制偏差的签名，需在FactoryTalk Batch配方编辑器中为该阶段类的报告指定这些限制。  

当批次运行且发生需要签名验证的参数或报告偏差，或操作员发出需要签名验证的命令时，签名将添加到FactoryTalk Batch View、电子签名HMI控件或eProcedure客户端的签名列表中，提示相应用户输入签名。所有签名作为签名事件记录在FactoryTalk Batch View的事件日志查看器中。生成签名事件数据后，可创建FactoryTalk事件归档器报告或其他捕获电子签名数据的报告。  


#### 签名模板  
在设置需要电子签名的阶段类和配方之前，需先建立一组签名模板。每个模板定义所需的签核数、签核含义、签核是否包含评论，以及哪些用户或用户组具有完成签核的安全权限。根据业务流程需要创建多个模板以区分不同签名类型。  

创建签名模板的过程包括三个主要步骤：  
1. 添加签名模板  
2. 配置签名模板签核  
3. 分配签核的安全权限  


#### 编辑签名模板对话框  

| **名称**               | **用途**                                                                                                                                                                                                                                                                                                                                 |
|------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **常规选项卡**         |                                                                                                                                                                                                          |
| Template Name          | 显示签名模板列表中所选模板的名称。若列表中无模板，此选项禁用。<br>- 模板名称必须唯一，长度1-50字符；<br>- 必须以字母开头，后续可包含字母、数字或下划线；<br>- 不区分大小写，不允许空格。                                                                                                                                                                                                                                                           |
| Template Index         | 模板列表中所选模板的唯一标识号，必须为1-2,147,483,647的正整数。                                                                                                                                                                                                                                                                         |
| Signoffs Required      | 此模板代表的验证策略所需的签名数。                                                                                                                                                                                                                                         |
| Last Signoff           | 指示哪个签核必须在其他签名输入后最后完成。若选“无”，签名可按任意顺序输入。                                                                                                                                                                                                                                                             |
| New Template           | 打开“创建签名模板”对话框以添加新模板到列表。                                                                                                                                                                                                                               |
| Delete Template        | 从列表中删除所选模板。若模板被任何命令、阶段类参数或报告的验证策略使用，则无法删除。                                                                                                                                                                                                                                                   |
| **签核选项卡**         |                                                                                                                                                                                                          |
| Template Name          | 列出在常规选项卡中添加的模板，选择模板以查看或配置签核信息。                                                                                                                                                                                                                                                                             |
| Signoff                | 列表中的每个数字代表所选模板的必需签名，数值由常规选项卡中“所需签核数”决定。选择签核编号时需考虑常规选项卡中“最后签核”的选择。                                                                                                                                                                                                         |
| Meaning（可选）        | 输入描述所选签核意义的短语（如“签名者授权命令”“签名者完成”），该内容作为签核事件的一部分记录在事件日志中，长度0-80字符，可包含任何可见可打印字符，不支持特殊控制字符。                                                                                                                                                                                                                         |
| Comment                | 选择签核时签名者是否可添加评论（可选、必需或不允许）。                                                                                                                                                                                                                     |
| Security Permissions   | 显示可完成所选签核的用户和用户组。若为空，说明尚未配置安全权限，关闭对话框前必须为所有签核配置权限。                                                                                                                                                                                                                                   |
| Add                    | 打开“选择用户或组”对话框，选择有权限完成签核的用户和组。                                                                                                                                                                                                                 |
| Delete                 | 从安全权限中删除所选用户或组，移除其完成签核的权限。                                                                                                                                                                                                                     |


#### 添加签名模板  
**操作步骤**：  
1. 选择“开始”>“Rockwell Software”>“设备编辑器”。  
2. 选择“文件”>“打开”，选择区域模型文件。  
3. 选择“编辑”>“签名模板”，打开编辑对话框。  
4. 选择“新建模板”，打开创建对话框。  
5. 在“模板名称”中输入唯一名称（以字母开头，可包含字母、数字、下划线，不区分大小写，无空格）。  
   **提示**：名称应便于识别模板属性或用途，配置命令验证策略、阶段类和配方时用于标识模板。  
6. （可选）“模板索引”默认生成唯一编号，如需修改，输入正整数（若输入小数，自动取整；若与其他模板重复，显示错误）。  
7. 选择“确定”，新模板添加到列表。  
8. 在“所需签核数”中选择模板需要的签名数。  
9. 在“最后签核”中选择必须最后完成的签核编号（若无需顺序，选“无”）。  
10. 配置模板的签核（见下一步）。  


#### 配置签名模板签核  
**前提条件**：已添加签名模板。  
**操作步骤**：  
1. 打开设备编辑器，进入“编辑签名模板”对话框的“签核”选项卡。  
2. 从“模板名称”中选择要配置的模板。  
3. 从“签核”中选择要配置的编号（与常规选项卡的“所需签核数”对应，需考虑“最后签核”的选择）。  
4. （可选）在“含义”中输入描述签核意义的短语（显示在事件日志中）。  
5. 从“评论”中选择签名者是否可添加评论（可选、必需或不允许）。  
6. 在“安全权限”下为签核分配用户或组权限（完成后，用户和组名将显示在安全权限区域，具体步骤见“分配签核安全权限”）。  
7. 选择“应用”。  
8. 若模板需要多个签核，重复步骤3-7直至完成所有配置。  
   **提示**：多个签核时，每个签核必须使用唯一用户ID和密码。  
9. 完成配置后，可返回常规选项卡添加其他模板或选择“确定”关闭对话框。  


#### 分配签核安全权限  
**前提条件**：已添加签名模板，并在签核选项卡中输入模板名称、选择签核编号和评论选项，输入含义。  
**操作步骤**：  
1. 打开设备编辑器，进入签核选项卡的“安全权限”区域，选择“添加”，打开“选择用户或组”对话框。  
2. 选择“显示所有”查看所有用户和组（包括FactoryTalk安全用户/组和Windows链接用户/组）。  
   **提示**：添加用户/组后更改FactoryTalk目录服务器可能导致签核失败。  
3. 选择合适的用户或组，选择“确定”。  
   **重要提示**：使用FactoryTalk Security配置电子签名后更改目录服务器可能导致签核失败。  


#### 移除签核权限  
**操作步骤**：  
1. 打开设备编辑器，选择“编辑”>“签名模板”，选中模板并进入签核选项卡。  
2. 在“安全权限”中选择要移除的用户或组，选择“删除”，确认后选择“确定”。  


#### 删除签名模板  
**限制条件**：若模板用于以下场景，则无法删除：  
- 任何命令的验证策略；  
- 阶段类参数或报告的验证策略；  
- 配方的批准流程。  
**前置操作**：  
- 修改使用该模板的命令验证策略，更换模板或取消签名验证；  
- 修改阶段类参数或报告的验证策略，更换模板或删除参数/报告；  
- 修改配方批准步骤的签核模板。  
**操作步骤**：  
1. 打开设备编辑器和区域模型文件，选择“编辑”>“签名模板”。  
2. 选中要删除的模板，选择“删除模板”，从列表中移除后选择“确定”。  


#### 修改签名模板  
**限制条件**：若模板当前用于任何命令、阶段类参数或报告的验证策略，或分配给配方批准步骤，则无法修改模板名称或索引。  
**前置操作**：同删除模板的前置操作。  
**重要提示**：更改模板的“所需签核数”可能影响“最后签核”的值。若更改导致“最后签核”大于“所需签核数”，“最后签核”自动改为“无”。  
**操作步骤**：  
1. 打开设备编辑器和区域模型文件，选择“编辑”>“签名模板”，选中要修改的模板。  
2. 在常规选项卡中按需修改字段，选择“确定”。  


#### 命令验证策略  
设置命令验证策略以获取操作员通过FactoryTalk Batch View或HMI控件发出的批次/阶段命令的签名。配置前需先创建描述命令签核策略的签名模板。  
**重要提示**：若启用“移除”命令的签名验证，所有发送至服务器的AUTOREMOVE执行将失败并生成错误（AUTOREMOVE用于批次状态为COMPLETE时自动移除）。  


#### 为命令添加电子签名  
**操作步骤**：  
1. 打开设备编辑器，选择“编辑”>“命令策略”。  
   **提示**：当前FactoryTalk Security不支持保护eProcedure指令文件，需对“参数更改”设置电子签名以防止未授权用户执行指令。  
2. 选中需要电子签名的命令旁的复选框。  
3. 从“选择模板”中选择定义该命令签名策略的模板，选择“确定”，模板名称将显示在命令旁。  
4. 重复步骤2-3配置其他命令，完成后选择“确定”。  


#### 编辑命令验证策略  
**对话框组件说明**：  
- **Command**：显示可配置电子签名的命令（只读）。  
- **Requires Signature**：打开选择模板对话框，选中后命令执行时需要电子签名。  
- **Signature Template**：显示命令的验证策略模板，若无需签名则禁用。点击浏览可更换模板。  


#### 更改命令验证策略  
**前提条件**：已存在描述新签核策略的签名模板（若无则先创建）。  
**操作步骤**：  
1. 打开设备编辑器，选择“编辑”>“命令策略”。  
2. 点击要更改的签名模板旁的浏览按钮。  
3. 在选择模板对话框中选中新模板，选择“确定”，新模板名称将显示在命令旁。  
4. 重复步骤2-3更改其他策略，完成后选择“确定”。  


#### 移除命令的签名要求  
**操作步骤**：  
1. 打开设备编辑器，选择“编辑”>“命令策略”。  
2. 清除对应命令旁的“需要签名”复选框，模板框变为灰色，表示不再使用该模板。  
   **提示**：若重新启用签名，选中复选框即可恢复之前的模板。  
3. 选择“确定”。