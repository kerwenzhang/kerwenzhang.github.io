---                
layout: post                
title: "FTBatch Material Getting Results"                
date:   2025-7-3 17:30:00                 
categories: "FTBatch"                
catalog: true                
tags:                 
    - FTBatch                
---      

# 物料管理器介绍  
FactoryTalk®批次物料管理器是FactoryTalk批次服务器套件及相关软件应用的组成部分。


### 什么是物料管理器？  
作为FactoryTalk批次组件之一，物料管理器提供与企业物料管理系统关联的工厂级物料管理和跟踪功能。物料管理器按物料类型、批次和子批次管理和跟踪物料使用情况，同时管理和跟踪容器、储罐、托盘以及固定和临时存储位置。它还为包含多个批次（无论是复合批次还是推流分离批次）的散装容器提供自动支持。  

物料管理器将物料定义添加到配方中，显著减少灵活存储设施所需的配方数量。物料消耗、生产以及物料与容器和储罐的关联会被自动记录，为工艺单元内部和跨单元的物料正向和反向跟踪提供完整信息。  

基于物料的配方（称为“物料配方”）使您能够根据所用物料定义配方，而不仅限于工厂设备。物料配方使用启用物料的阶段，这些阶段在设备编辑器中配置并存储在区域模型中。启用物料的阶段支持将物料指定为查找合适设备并在控制配方中绑定到该设备的方式。  


#### FactoryTalk批次物料管理器  
FactoryTalk批次物料管理器用于跟踪批次配方中的物料消耗，由两个组件组成：物料服务器和物料编辑器。  

物料编辑器提供界面，帮助创建物料数据库，其中包含物料、批次、子批次、容器和存储位置数据。物料服务器提供物料数据库与FactoryTalk批次服务器之间的通信。在批次运行期间，可用容器信息会呈现给操作员以进行绑定决策。<strong>绑定是将控制配方中的步骤映射到工厂实际设备的过程</strong>。批次运行后，消耗或分配的数量会在物料数据库中更新，以用于库存跟踪。  

物料服务器由一组组件组成，这些组件协同工作以服务各种应用程序。物料服务器服务的主要应用程序包括物料编辑器、FactoryTalk批次服务器、FactoryTalk批次配方编辑器和FactoryTalk批次设备编辑器。任何第三方应用程序也可基于公开的物料对象模型（MOM）使用自定义解决方案。  




### 物料数据  
要实现基于物料的配方，必须配置三种类型的数据：  
1. **物料数据**：使用物料编辑器添加物料、批次、子批次及其容纳的容器，这些数据存储在物料数据库中。  
2. **设备数据**：使用FactoryTalk批次设备编辑器创建启用物料的阶段，然后将生成的设备模块与容器关联。  
3. **配方数据**：使用FactoryTalk批次配方编辑器定义配方中使用的物料和数量。  

配置物料数据分为两个阶段：  
- 第一阶段是初始系统配置，即添加特定安装独有的元素（如物料类型、物料、物料存储容器和存储位置）的过程。一旦这些初始元素被定义、配置和测试，初始系统配置即视为完成。  
- 第二阶段是持续系统维护，即保持基于物料的配方系统最新和可操作的日常活动过程。例如，向数据库添加新批次物料或分配现有物料批次。


# 物料服务器简介  

为便于理解和教学，本指南涉及配置和使用随FactoryTalk批次安装的示例文件。SampleDemo文件夹包含模拟工厂的完整区域模型和配方。运行演示前，请执行以下操作：  
- 配置网络编辑器以识别物料数据库  
- 添加FactoryTalk安全用户  
- 配置FactoryTalk批次服务器以识别所需项目目录  
- 选择初始化路径和文件名  
- 启动FactoryTalk批次服务器和FactoryTalk批次阶段模拟器  
**提示**：本指南概述SampleDemo2演示文件的配置和使用。由于这些文件在全文中作为示例，建议您按步骤遵循本演示的操作说明。  


#### 物料服务器概览  
FactoryTalk批次物料服务器是一组协同工作的组件，用于为各种客户端应用程序提供服务。物料服务器服务的主要客户端包括物料编辑器、FactoryTalk批次服务器、FactoryTalk批次配方编辑器和FactoryTalk批次设备编辑器。此外，任何第三方应用程序均可基于公开的物料对象模型（MOM）使用自定义解决方案。物料服务器还与SQL Server交互，以读写物料数据库。  


#### 物料服务器通信  
物料服务器在COM+组件（组件对象模型（COM）的扩展）的上下文中运行。该组件位于客户端工作站上，提供丰富的编程模型。有关物料对象模型的更多信息，请参阅《FactoryTalk批次物料服务器API技术参考》。  

物料服务器协调以下功能：  
- 在活动日志中记录配置和运行时期间对物料数据库执行的操作。  
- 启动时将物料和容器列表从物料数据库加载到批次服务器，以填充区域模型的物料和容器枚举集。  
- 将设备模块/容器关联从区域模型加载到物料数据库。  
- 绑定期间与FactoryTalk批次服务器通信：  
  - 单元绑定时，FactoryTalk批次服务器与物料服务器通信，以确定单元内的容器是否可满足所需物料。  
  - 阶段绑定时，FactoryTalk批次服务器与物料服务器通信，获取基于步骤中添加或分配物料的容器和设备模块列表。在提示阶段绑定中，操作员从容器-设备对列表中选择绑定方案；在自动阶段绑定中，阶段基于当前容器优先级选择；在手动阶段绑定中，FactoryTalk批次服务器与物料服务器通信，获取支持所需物料的容器、批次和设备模块列表，并呈现给操作员以选择要绑定到物料步骤的设备模块。  
- 批次运行期间，使用实际消耗或分配的数量更新物料数据库。添加或分配时，当“进料完成”为真时，FactoryTalk批次服务器将实际数量传达给物料服务器；当“进料完成”为假时，FactoryTalk批次服务器将实际数量传达给物料服务器，后者计算承诺量与实际量的差值并返回给批次服务器，批次服务器使用该差值更新分流进料的设定点。  

本指南还将描述不同的绑定方法及如何处理分流进料。  


#### 配置示例演示  
安装过程会将SampleDemo1和SampleDemo2文件夹放置在硬盘的BATCHCTL共享目录中。每个SampleDemo文件夹内有四个子文件夹，包含区域模型的文件。要运行示例演示，需配置网络编辑器以定位物料数据库、添加FactoryTalk安全用户、配置FactoryTalk批次服务器以定位区域模型，然后验证区域模型中的配方。  

**重要提示**：SQL Server中默认数据库MaterialBasedRecipe和SAMPLE2_Materials不可删除。您可自由添加其他数据库用于生产或测试，但必须保持原始安装的数据库完整，即使未使用。  


#### 配置网络编辑器  
使用包含SampleDemo2配方物料的SQL数据库位置配置物料服务器：  
1. 选择 **开始 > Rockwell Software > 物料管理器**，然后选择 **网络编辑器**，打开“网络编辑器”窗口。  
2. **重要提示**：执行此过程需要管理员权限。选择“物料服务器”。  
3. 选择 **配置**，打开“配置MaterialTrack”对话框。  
4. 在“MaterialTrack数据库”框中输入 **SAMPLE2_MATERIALS**，然后选择 **确定**。  
5. 选择 **同步**。  
6. 选择 **文件 > 退出**，然后单击 **是** 退出网络编辑器。  


#### 配置示例FactoryTalk批次服务器  
要设置示例演示，需配置FactoryTalk批次服务器以定位包含演示文件的文件夹，以及FactoryTalk批次服务器在系统故障时写入数据的\Restart和bin文件夹。在FactoryTalk批次设备编辑器中配置FactoryTalk批次服务器：  
1. 选择 **开始 > Rockwell Software > 设备编辑器**，打开FactoryTalk批次设备编辑器（如有提示，登录FactoryTalk）。  
   **重要提示**：执行此过程需要管理员权限。  
2. 选择 **选项 > 服务器选项**，打开“服务器选项”对话框并显示“项目设置”选项卡。  
3. 在“项目目录”区域中，选择“主日志”浏览按钮，打开“选择目录”对话框。  
4. 从“查找范围”列表中选择SampleDemo1\Journals文件夹，然后选择 **打开**。  
5. 选择“错误日志”浏览按钮，打开“选择目录”对话框。  
6. 从“查找范围”列表中选择SampleDemo1\Logs文件夹，然后选择 **打开**。  
7. 单击“指令”浏览按钮，打开“选择目录”对话框。  
   **重要提示**：为使电子流程服务器启动，必须为区域模型中每个基于指令的阶段定义指令路径和指令文件。（有关定义基于指令的阶段的说明，请参阅《FactoryTalk批次设备编辑器用户指南》。）  
8. 选择“设备数据库”浏览按钮，打开“选择设备数据库”对话框。  
9. 从“查找范围”列表中打开SampleDemo1\Recipes文件夹，选择ice_cream1.cfg文件，然后选择 **打开**。  
10. 在“使用以下方式存储配方”区域中选择“二进制文件”，然后选择“配方目录”浏览按钮，打开“选择目录”对话框。  
11. 从“查找范围”列表中选择SampleDemo1\Recipes文件夹，然后选择 **打开**。  
12. 选择“重启控制”选项卡。  
13. 选择“主路径”浏览按钮，打开“选择目录”对话框。  
14. 从“查找范围”列表中选择SampleDemo1\Restart文件夹，然后选择 **打开**。  
15. 选择“辅助路径”浏览按钮，打开“选择目录”对话框。  
16. 从“查找范围”列表中选择Bin文件夹。  
17. 选择“批次报告”选项卡，保留“从不（无队列）”作为默认报告应用程序。  
18. 选择 **确定** 关闭“服务器选项”对话框。  
19. 选择 **文件 > 退出** 退出FactoryTalk批次设备编辑器。  
**提示**：这些步骤设置FactoryTalk批次服务器以运行本手册中的教程步骤。设置FactoryTalk批次系统时还需考虑许多其他设置。（有关“服务器选项”对话框的更多信息，请参阅《FactoryTalk批次管理员指南》。）  


#### 重建配方目录  
要运行演示配方，必须重建配方目录并使用FactoryTalk批次配方编辑器验证区域模型中的配方。  
**重要提示**：执行此过程需要管理员权限。  
1. 选择 **开始 > Rockwell Software > 配方编辑器**，FactoryTalk批次配方编辑器读取区域模型。  
   **提示**：如果使用非管理员权限账户登录，右键单击“配方编辑器”并选择 **更多 > 以管理员身份运行** 以提升权限运行。  
2. 如有提示，登录FactoryTalk。如果显示提示验证配方的消息，选择 **取消**。  
3. 选择 **文件 > 重建配方目录**。重建完成后，选择 **确定**，然后选择 **是** 验证配方。  
4. 配方验证完成后，选择 **接受** 保存配方，然后选择 **关闭**。  
5. 选择 **文件 > 退出** 退出FactoryTalk批次配方编辑器。  


#### 启动FactoryTalk批次和物料管理器服务器  
FactoryTalk批次和物料管理器服务器可能在计算机启动时自动启动。默认情况下，FactoryTalk批次服务器以生产模式启动。如果未激活FactoryTalk批次，教程可在演示模式下运行。演示模式下，FactoryTalk批次服务器运行两小时后停止。  
**提示**：FactoryTalk批次服务器未激活时不会以生产模式启动。FactoryTalk批次服务器启动时，物料管理器服务器自动启动。有关激活物料管理器的更多信息，请参阅相关内容。  
1. 启动或重启FactoryTalk批次服务器：  
   a. 选择 **开始 > Rockwell Software > 批次服务管理器**。  
   **重要提示**：如果使用非管理员权限账户登录，右键单击“批次服务管理器”并选择 **更多 > 以管理员身份运行** 以提升权限运行。  
   b. 在FactoryTalk批次服务管理器中，如果“服务”框中未列出FactoryTalk批次服务器，选择该服务器。如果FactoryTalk批次服务器正在运行，选择 **停止**。  
2. 如果“计算机”框中未显示安装FactoryTalk批次服务器的计算机名称，选择 **选择计算机** 按钮。  
3. 在“选择计算机”对话框的“输入要选择的对象名称”下，输入安装批次服务器的计算机名称（或选择 **高级** 搜索计算机），然后选择 **确定**。  
   **提示**：FactoryTalk批次服务管理器必须与所选计算机的Windows服务管理器通信，以确定可用服务。建立通信时可能会有明显延迟。如果服务管理器无法与所选计算机的Windows服务管理器通信，将显示消息。  
4. 从“服务”列表中选择FactoryTalk批次服务器。  
   **提示**：如果列表中显示“无批次服务”，则所选计算机未安装FactoryTalk批次服务器。有关安装说明，请参阅《FactoryTalk批次组件安装和升级指南》。  
5. 要以演示模式启动FactoryTalk批次服务器，选择 **允许演示模式**。  
6. 选择用于启动服务器的方法：  
   - **冷启动**：以冷状态重启FactoryTalk批次服务器，启动时清除所有日志数据或配方内容。  
   - **热启动**：重启FactoryTalk批次服务器，恢复服务器先前终止时批次列表中的批次集。  
   - **全热启动**：仅当FactoryTalk批次服务器能够将所有批次恢复到批次列表时才重启。  
7. 选择 **启动/继续** 按钮。“服务状态”区域从“已停止”变为“启动挂起”。片刻后显示“正在运行”，指示灯变为绿色。物料服务器随FactoryTalk批次服务器自动启动。  
   FactoryTalk批次阶段模拟器自动启动，最小化该窗口。  
8. 选择 **关闭** 关闭FactoryTalk批次服务管理器。  
   **提示**：演示模式下运行时如果连接丢失，请确保模拟器正在运行并尝试重新启动服务器。有关更多信息，请参阅“启动FactoryTalk批次阶段模拟器”。  


#### 启动FactoryTalk批次阶段模拟器  
FactoryTalk批次附带阶段逻辑模拟程序（称为FactoryTalk批次阶段模拟器），用于在不连接PCD的情况下模拟批次过程。阶段模拟器模仿数据服务器的功能，并可使用OPC通信协议与FactoryTalk批次服务器通信。阶段模拟器是用于测试、实验和演示的强大工具。本指南使用阶段模拟器运行示例演示。  
**提示**：如果需要阶段模拟器并使用OPC协议进行通信，FactoryTalk批次服务器会自动启动阶段模拟器。检查Windows任务栏以确认阶段模拟器是否已启动。  
要正确运行示例演示，请在阶段模拟器中打开ice_cream1.sim文件：  
1. 如果阶段模拟器已在运行，从Windows任务栏将其最大化；如果未运行，选择 **开始 > Rockwell Software > 模拟器**，打开FactoryTalk批次阶段模拟器。  
2. **重要提示**：执行此过程需要管理员权限。选择 **文件 > 打开**，打开“打开模拟器配置文件”对话框。  
3. 从“查找范围”列表中打开Program Files > Rockwell Software > Batch > SampleDemo1 > Recipes文件夹，选择ice_cream1.sim文件，然后选择 **打开**。  
4. 最小化FactoryTalk批次阶段模拟器窗口。  


#### 验证PCD通信  
1. 选择 **开始 > Rockwell Software > 批次服务管理器**，打开FactoryTalk批次服务管理器。  
2. 确保“服务”框中已选择FactoryTalk批次服务器。  
3. 选择 **服务器详细信息**，打开“FactoryTalk批次服务器详细信息”对话框。  
4. 选择“PCD通信”选项卡，“数据服务器状态”区域显示与OPC_SIM数据服务器（阶段模拟器）的连接状态，应为“PHASES GOOD”。  
5. 在“标签验证”区域中选择 **开始** 开始验证过程，标签验证过程需要几分钟。  
6. 当“状态”框显示“已完成”时，选择 **确定** 关闭“FactoryTalk批次服务器详细信息”对话框。  


#### 总结  
本章中，您：  
- 配置了网络编辑器和FactoryTalk批次服务器以运行示例演示  
- 以演示模式启动了FactoryTalk批次服务器  
- 在FactoryTalk批次模拟器中打开.sim文件以运行示例演示  

本章简要概述了物料服务器的功能。（有关FactoryTalk批次服务器的更多信息，请参阅《FactoryTalk批次管理员指南》；有关物料服务器的更多信息，请参阅《FactoryTalk批次物料管理器管理员指南》。）  

本文档的其余部分将引导您通过示例演示探索物料管理器。请按照分步说明学习如何使用物料管理器和FactoryTalk批次软件定义和运行基于物料的配方。



# 物料编辑器简介  

FactoryTalk®批次物料编辑器提供界面，帮助您创建物料数据库，该数据库由存储在Microsoft SQL Server数据库中的若干数据表组成。物料编辑器将物料数据库呈现为两种数据类型：  
- **物料配置数据**：定义物料，包含物料名称、描述、属性、最小和最大数量及默认数量等项。  
- **物料存储配置数据**：定义容纳物料的容器，包含容器名称、描述、类型、属性和容量等项。  

您还可使用物料编辑器通过将物料分配到容器并将批次分发到容器，来创建物料与容器数据之间的关联。  

本章中，您将向安装物料管理器时自动创建的SAMPLE2_MATERIALS.mdf数据库添加新数据。  


#### 启动物料编辑器  
单击 **开始 > Rockwell Software > 物料管理器 > 物料编辑器**。  
1. **重要提示**：执行此过程需要管理员权限。展开“物料”文件夹，左窗格中将显示SAMPLE2_MATERIALS物料数据库中的物料列表。  
2. 单击“物料”文件夹，右窗格中将显示物料的详细列表。  
   物料是配方成分的逻辑表示（如奶油或糖）。对于每种物料，您需创建批次（即物料的物理实例）。例如，当工厂收到一批新奶油时，添加新批次以唯一标识该批奶油。将批次分发到容器时，分发的部分成为子批次（即存储在容器中的物理库存）。例如，一批奶油可分为两个子批次，存储在两个独立容器中。  
3. 折叠“物料”文件夹，展开“位置”文件夹，然后展开“独立容器”文件夹，将显示SAMPLE2_MATERIALS物料数据库中的存储位置列表。右窗格中将保留物料的详细列表，直至您单击其他文件夹。  
   “独立容器”文件夹显示容器列表（容器是库存的存储库）。在物料管理器中，您定义物料与容器之间的关联；在区域模型中，定义容器与设备模块之间的关联。FactoryTalk批次服务器在运行时使用这些关联来查找包含相应物料的容器及其关联的设备模块，以绑定到启用物料的阶段步骤。  
   “位置”文件夹包含存储位置（容器的分组）。通常，分配给存储位置的容器生命周期较短，可能由一个配方创建并由下一个配方删除。这是预称重配方的常见操作：将测量数量的物料分发到托盘上，然后混合配方将托盘用作物料来源。  
4. 折叠“位置”和“独立容器”文件夹。  


#### 添加物料状态  
要在批次中使用容器及容器内的物料，两者必须处于“就绪可用”状态。任何其他状态均会阻止物料和容器的使用，并为您提供识别离线设备和物料的方法。例如，可创建名为“QATest”的批次状态并分配给物料批次，以在测试期间防止其被使用。若要重新使用该批次和容器，需将状态更改为“就绪可用”。  

本练习中，您将创建名为“维护”的容器状态，以便在容器维修时阻止其使用。  
1. 从“编辑”菜单中选择“状态States”，打开“状态配置”对话框并显示“批次Lot”选项卡，其中显示SAMPLE2_MATERIALS.mdf物料数据库中定义的批次状态。  
2. 选择“容器”选项卡，显示SAMPLE2_MATERIALS.mdf物料数据库中定义的容器状态。  
3. 单击 **新建状态** 按钮，打开“创建容器状态”对话框。  
4. 在“名称”框中输入 **Maintenance**。  
5. 在“描述”框中输入 **Out of service for maintenance**。  
6. 单击 **确定**，新状态将添加到列表中。由于未分配控制器ID，物料编辑器会自动分配下一个可用编号。  
   控制器ID在物料编辑器中用于唯一标识物料数据库中的项目。PCD程序员可使用这些控制器ID访问物料数据库中的数据片段。  
7. 单击 **关闭**。  


#### 添加物料类型  
物料类型用于信息和组织目的，不影响基于物料的配方的构建或执行。定义物料时，物料类型会显示在选择列表中。  

本练习中，您将创建两种新物料类型：“干性”和“液态”。  
1. 从“编辑”菜单中选择“物料类型Material Types”，打开“物料类型”对话框。  
   SAMPLE2_MATERIALS.mdf物料数据库中定义的类型为“成品”、“中间品”和“原料”（默认值，由蓝色信息图标指示），不可编辑。您可添加更多可编辑的物料类型。  
2. 单击 **添加** 按钮，打开“编辑物料类型”对话框。  
3. 在“名称”字段中输入 **Dry**。  
4. 在“描述”字段中输入 **Raw material in dry state**。  
   将“控制器ID”保留为零，物料编辑器将分配下一个可用编号。  
5. 单击 **确定**，“干性”物料类型将显示在列表中。  
6. 单击 **添加** 按钮，添加另一种类型“液态”，描述为 **液态原料**。  
7. 单击 **确定**，然后单击 **关闭**。  


#### 添加物料类  
物料类定义一组相似的物料。例如，名为“甜味剂Sweetener”的物料类可包含砂糖和玉米糖浆等物料。物料类用于组织目的，不影响基于物料的配方的执行。  

您可使用物料类简化物料到存储容器的分配。定义存储位置时，必须指明可存储在容器中的物料。使用物料类，可将类中的所有物料成员分配到容器，而非逐个分配物料。  

本练习中，您将为脱脂冷冻酸奶产品创建新物料类，并定义属性以定义该物料类。  
1. 从“编辑”菜单中选择“物料类Material Classes”，打开“物料类”对话框，显示SAMPLE2_MATERIALS.mdf物料数据库中定义的物料类。  
   物料类按字母顺序显示。“未分组”是系统默认值（由蓝色信息图标指示），因此不可编辑。  
2. 单击 **添加**，打开“创建物料类”对话框并显示“常规”选项卡。  
3. 在“名称”框中输入 **ICE_MILK_NON_FAT**。  
4. 在“描述”框中输入 **冰乳产品 - 脱脂冷冻酸奶**。  
   将“控制器ID”保留为零，物料编辑器将分配下一个可用编号。  
5. 单击 **应用**，打开“编辑物料类”对话框并显示“常规”选项卡。  
6. 选择“属性”选项卡，然后单击 **新建属性** 按钮。  
7. 在“物料类属性”框中输入 **butterfat_content**。  
8. 在“最小值”框中输入 **2**。  
9. 在“最大值”框中输入 **7**。  
10. 在“默认值”框中输入 **5**。  
11. 在“工程单位”框中输入 **Percent**。  
12. 单击 **应用**，然后选中“同步”复选框。  
13. 单击 **确定**，单击 **是** 传播更改，然后单击 **关闭**。  


#### 添加物料  
物料是配方中的成分。对于每种物料，您需指定批次（即物料的实例）。将批次分发到容器时，批次的分发部分成为子批次。子批次是存储在容器中的物理库存。  

您将在产线中添加新产品——巧克力榛子冰淇淋。已有三重巧克力冰淇淋的配方使用相同物料，因此只需添加“榛子（原料）”和“巧克力榛子冰淇淋（成品）”作为物料。  
1. 右键单击“物料”文件夹，然后选择 **新建物料**，打开“创建物料”对话框并显示“常规”选项卡。  
2. 在“名称”框中输入 **HAZELNUT**。  
3. 在“描述”框中输入 **榛子块**。  
4. 在“工程单位”框中输入 **KG**。  
5. 必要时从“类型”列表中选择“原料”。  
6. 从“类”列表中选择 **NUT**。  
7. 必要时从“默认批次状态”列表中选择“就绪可用”。  
   可使用“库存键Inventory Key”将物料库存与工厂生产流程对接。本练习中保留“库存键”为空。将“控制器ID”保留为零，物料编辑器将分配下一个可用编号。  
8. 单击 **确定**。  
9. 以相同方式添加：  
   - 名称 = IC_CHOCOLATE_HAZELNUT  
   - 描述 = Chocolate Hazelnut Premium Ice Cream  
   - 工程单位 = KG  
   - 类型 = 成品  
   - 类 = ICE_CREAM_PREMIUM  
   - 默认批次状态 = 就绪可用  


#### 添加容器  
容器是库存的存储库。在物料编辑器中，您创建容器并将物料批次分发到容器。运行批次时，FactoryTalk批次服务器会要求物料服务器查找满足步骤物料需求的容器。如果容器的总库存量大于定义的“剩余量”属性，则选择该容器绑定到批次。与物料关联的容器类型也会影响绑定过程（后续章节将详细介绍）。  

物料管理器支持三种容器类型：  
- **复合容器Composite Containers**：一次仅容纳一种物料和批次。创建新子批次并链接到复合容器时，子批次会在容器内合并。例如，存储多批牛奶的储罐是复合容器，每批添加到容器的子批次会混合在一起，无法区分。绑定时将考虑容器的全部内容。  
- **推流容器Plug-Flow Containers**：仅容纳一种物料，但可容纳多个子批次。添加到推流容器的每个子批次保持独立，以先进先出方式使用。放入容器的第一个子批次最先使用，然后是第二个子批次，依此类推。物料管理器跟踪每个子批次的使用情况，并识别每个批次何时耗尽。绑定时仅考虑最先流出的子批次。  
- **托盘容器Pallet Containers**：容纳多种物料及每种物料的多个子批次。每个子批次可拥有标签（子批次唯一的属性），其他所有子批次属性均继承自批次属性。可使用标签区分唯一的子批次，添加到托盘容器的所有子批次可随时使用。绑定时，将考虑托盘上的每个子批次。  

本练习中，您将创建两个新的独立容器来存储榛子。  
1. 展开“物料存储配置Material Storage Configuration”文件夹，右键单击“独立容器Independent Containers”文件夹，然后选择 **新建物料存储容器**，打开“创建物料存储容器”对话框。  
2. 在“名称”框中输入 **NUT_BIN3**。  
3. 在“描述”框中输入 **榛子存储**。  
4. 在“容量”框中输入 **10000**。  
5. 在“剩余量”框中输入 **200**。  
6. 在“工程单位”框中输入 **KG**。  
7. 在“容器类型”区域中选择“推流”。  
   将“状态”保留为默认“就绪可用”，“控制器ID”保留为0（零）。将控制器ID保留为零，物料编辑器将分配下一个可用编号。  
8. 单击 **确定**。  
9. 添加第二个独立容器：  
   - 名称：NUT_BIN4  
   - 描述：榛子存储  
   - 容量：10000  
   - 剩余量：200  
   - 工程单位：KG  
   - 状态：Ready_to_Use  
   - 容器类型：推流  
10. 单击 **确定**。  


#### 将物料与容器关联  
现在已定义两种新物料和容器，需要将它们相互关联。  

本练习中，将HAZELNUT物料与两个独立容器关联，并将IC_CHOCOLATE_HAZELNUT物料与存储位置中的所有容器关联。  
1. 展开“物料”文件夹，右键单击HAZELNUT，然后选择 **属性**，打开“编辑物料”对话框并显示“常规”选项卡。  
2. 选择“容器”选项卡，展开“独立容器”文件夹，选择NUT_BIN3，然后单击 **添加** 按钮。  
3. 以相同方式添加NUT_BIN4。  
4. 单击 **确定**。  
5. 双击IC_CHOCOLATE_HAZELNUT，打开“编辑物料”对话框并显示“常规”选项卡。  
6. 选择“容器”选项卡，选择DEEP_FREEZE存储位置，然后单击 **添加位置Add Location** 按钮，Deep_Freeze存储位置中的所有容器将添加到“已配置容器”区域。  
7. 单击 **确定**。  


#### 创建批次lots  
您创建的物料仅是物料的逻辑定义，实际物理物料是批次。每个批次继承物料的特征和属性，并包含物理数量和用于标识批次的控制器ID。单一物料可有多批次，每个批次通过批次名称唯一标识。  

本练习中，您将为最新到货的10,000公斤榛子创建批次。  
1. 展开“物料”文件夹，右键单击HAZELNUT，然后选择 **属性**，打开“编辑物料”对话框并显示“常规”选项卡。  
2. 选择“批次Lots”选项卡，然后单击 **新建批次New Lot** 按钮。  
3. 在“批次名称”框中输入 **Hazelnut100**。  
4. 在“数量”框中输入 **10000**。  
   将“状态”保留为默认“就绪可用”，“控制器ID”保留为0（零）。将控制器ID保留为零，物料编辑器将分配下一个可用编号。  
5. 单击 **应用**。  


#### 将批次 lots分发到容器containers  
现在已定义容器和批次，需要将批次分发到容器。分发批次时，将创建由标签标识的子批次。  
- **子批次sublot**：存储在容器中的批次数量，继承批次的属性和值，是跟踪所有物料移动、生产和消耗的基础。  
- **标签label**：子批次唯一的属性，通常视为分配给特定子批次的条形码。以托盘为例，该概念易于理解：托盘上存放许多预测量的物料袋（子批次），每个袋子都有唯一的条形码（标签）。  

本练习中，您将把榛子批次分发到存储在两个独立容器中的两个子批次。  
1. 保持“编辑物料”对话框打开，选择“库存Inventory”选项卡，上一练习中添加的批次显示为“未分发”。  
2. 单击行号选择批次记录，然后单击 **分发** 按钮，打开“分发批次”对话框。  
3. 在“标签”框中输入 **Hazelnut100_1**。  
4. 在“数量”框中输入 **5000**。  
5. 展开“独立容器”文件夹，显示所有可能存储榛子的独立容器。  
6. 选择NUT_BIN3。  
7. 单击 **确定**，批次的一半被分发，剩余部分显示在新行中为“未分发”。  
8. 将剩余的榛子批次分发到NUT_BIN4，标签为Hazelnut100_2。  
9. 单击 **确定**。  


#### 退出物料编辑器  
您已输入构建新配方所需的信息，因此退出物料编辑器。从“文件”菜单中选择 **退出**，单击 **是** 确认退出。  


# 启用物料的阶段简介  

定义物料及容器或存储位置信息后，您即可重新配置区域模型以适应启用物料的阶段。启用物料的阶段支持将物料指定为查找合适设备的方式，并在控制配方中绑定到该设备。  

本章中，您将修改icecream_2.cfg文件以适配新增的容器。  


#### 打开区域模型  
1. 选择 **开始 > Rockwell Software > 设备编辑器Equipment Editor**。  
2. **重要提示**：执行此过程需要管理员权限。选择 **文件 > 打开**。  
3. 在“打开”对话框中，导航至SampleDemo2\Recipes，选择ice_cream2.cfg，然后单击 **打开**。区域模型将打开并显示WEST_PARLOR和NORTH_PARLOR工艺单元：  
   - WEST_PARLOR工艺单元是<strong>标准FactoryTalk批次配置</strong>，包含创建不同口味冰淇淋的配方。  
   - NORTH_PARLOR工艺单元演示了**物料跟踪的应用**，用于创建相同的冰淇淋口味。  


#### 命名区域  
启动时，FactoryTalk批次服务器会根据“服务器选项”对话框中选择的区域模型指定的“区域名称”清除物料服务器数据库中的信息。如果系统中有多个FactoryTalk批次服务器，分配唯一的区域名称至关重要。  

**重要提示**：如果在多FactoryTalk批次服务器系统中使用重复的区域名称，可能会导致批次失败。每个区域名称必须唯一。  

默认区域名称为AREA1，您需要将其更改为唯一名称：  
1. 从“编辑”菜单中选择 **区域**，打开“编辑区域”对话框。  
2. 在“名称”字段中输入 **ICECREAM_1**。  
3. 单击 **确定**。  


#### 查看枚举集  
物料管理器Material Manager会自动创建三个枚举集：MATERIALS、CONTAINERS和MATERIAL CLASSES，用于表示物料数据库中已配置的物料、容器、物料类及其各自的控制器ID。启动FactoryTalk批次设备编辑器、FactoryTalk批次配方编辑器和FactoryTalk批次服务器时，物料服务器会填充这些枚举集。  

您可在设备编辑器中查看MATERIALS、CONTAINERS和MATERIAL CLASSES枚举集，但必须使用物料编辑器进行任何修改。  

**提示**：对区域模型的某些修改需要验证所有配方，然后重启FactoryTalk批次服务器（尤其是设置为冷重启时）。由于MATERIALS、CONTAINERS和MATERIAL CLASSES枚举集源自物料数据库中的数据，因此在物料编辑器中进行的任何影响枚举集的更改也需要验证所有配方，然后重启批次服务器。因此，设计物料数据库时应尽可能减少维护需求，这一点至关重要。  
1. 从“编辑”菜单中选择 **枚举集Enumeration Sets**，打开“创建枚举集和枚举”对话框。  
2. 选择MATERIALS，枚举框中将按控制器ID的数字顺序显示物料列表。  
3. 向下滚动以查看在物料编辑器中添加的两种物料。  
   **提示**：NULL_CONTAINER和NULL_MATERIAL枚举是设备编辑器分配给每个枚举集的默认值，其他列出的枚举属于ice_cream2.cfg区域模型。  
4. 选择CONTAINERS，枚举框中将显示容器列表。  
   CONTAINERS枚举集仅包含独立容器和存储位置，不包含存储位置内的容器。这样，对存储位置内容器的更改不会影响区域模型。  
5. 选择MATERIAL_CLASSES，枚举框中将显示物料类列表。  
6. 单击 **确定** 关闭对话框。  


#### 创建启用物料的阶段  
如果没有物料管理器，您需要为配方中的每种物料创建一个阶段。在此示例中，需要为配方中使用的每种物料创建阶段：ADD_CREAM、ADD_EGG、ADD_SUGAR和ADD_MILK。  

如果每种物料有多个容器，情况会更复杂。例如，如果奶油存储在五个不同的容器中，则需要五个阶段、五个设备模块和五个配方才能从相应容器获取奶油。然后操作员必须根据奶油的存储位置选择要运行的配方。试想一下，当糖、鸡蛋和牛奶也存储在不同容器中时，所需的配方排列组合将非常复杂。  

使用物料管理器，您可以用一个启用物料的阶段替换所有这些阶段。在这种情况下，这些启用物料的阶段将物料移入工艺单元，因此被指定为物料添加阶段；另一种启用物料的阶段将物料移出工艺单元，因此被指定为物料分配阶段。启用物料的阶段可能同时支持这两种操作。  

**提示**：物料管理器当前跟踪添加和分配进料的物料转移，启用物料的阶段不跟踪单元或阶段之间的物料转移。  
1. 双击NORTH_PARLOR，显示单元层级。NORTH_PARLOR工艺单元包含两个完全相同的单元。包含启用物料阶段的单元配置与标准单元相同：创建单元类，然后创建单元类的实例。  
2. 双击NP_MIXER1，显示设备阶段和模块。  
3. 选择NP_ADDDAIRY_M1、NP_ADDSWEET_M1，然后选择NP_ADDEGG_M1，注意每个实例如何选择MBR_ADD阶段。  
   使用物料管理器，您可以从单个阶段创建多个设备模块。请注意，先前示例中的阶段ADD_CREAM、ADD_SUGAR、ADD_EGG和ADD_MILK已被单个启用物料的阶段MBR_ADD取代。正确设备模块的选择在批次运行时根据配方中步骤的配置确定。  
4. 在“阶段”列表中，双击MBR_ADD，打开“编辑阶段”对话框并显示“常规”选项卡。  
   选择“基于物料的配方Material Based Recipes”会将阶段标记为支持物料，并自动配置运行启用物料阶段所需的参数和报告。这还意味着基于此阶段的设备模块必须按协议编程，以便FactoryTalk批次和物料服务器能够跟踪物料使用情况。（请参阅第51页的“对启用物料的阶段进行编程”。）  


#### 添加启用物料的阶段参数  
物料管理器会自动为每个启用物料的阶段添加两个参数：MATERIAL和AMOUNT。物料管理器内置三个可选参数：CONTAINER、LOT和LABEL，也可以创建和使用自定义参数。  
1. 选择“参数”选项卡：  
   - MATERIAL参数定义查询物料数据库所需的最低物料规格，以将容器视为启用物料阶段的绑定候选。  
   - AMOUNT参数是设备模块的物料数量设定点或目标。物料添加表示为零或正值，物料分配表示为零或负值。有效值的最小/最大范围应反映阶段的可能用途。如果阶段要同时处理物料添加和分配，范围应涵盖正值和负值。  
2. 选择“添加可选物料参数Add Optional Material Parameters”，然后单击 **是**，将显示可选物料参数：  
   - CONTAINER参数, 使FactoryTalk批次服务器在运行时存储物料阶段步骤绑定到的容器，从而使容器值可下载到阶段逻辑。  
   - LOT参数, 对于物料添加，LOT参数是物料规格的一部分，用于查询物料数据库以获取可视为物料阶段绑定候选的容器；对于物料分配，它是分配给要分配库存的批次名称。  
   - LABEL参数, 对于物料添加，LABEL参数是物料规格的一部分，用于查询物料数据库以获取可视为物料阶段绑定候选的容器；对于物料分配，它是分配给要分配库存的标签名称。  
   - MATERIAL_CLASS参数, 使FactoryTalk批次服务器在批次添加到批次列表时向操作员显示对话框，以便操作员选择配方中使用的物料。  
   - 所有物料管理器参数均支持自动上传/下载功能。  
3. 禁用“添加可选物料参数”，然后单击 **是**。  


#### 添加启用物料的阶段报告参数  
每个启用物料的阶段都有两个必需的物料报告参数：ACTUAL_AMOUNT和FEED_COMPLETE，您也可以创建自定义报告参数。  
1. 选择“报告”选项卡：  
   - ACTUAL_AMOUNT报告参数保存设备模块消耗（物料添加）或生产（物料分配）的物料数量。物料添加表示为零或正值，物料分配表示为零或负值。  
   - ACTUAL_AMOUNT不必等于AMOUNT参数值，但符号应与配方阶段步骤的进料类型一致。  
   - FEED_COMPLETE报告参数是向FactoryTalk批次服务器发出的信号，表示添加或分配已成功完成。物料不足、存储容量不足、阶段故障或停止阶段都可能导致物料添加或分配中断。发生这种情况时，阶段逻辑会将FEED_COMPLETE设置为false，从而暂停批次执行，直到阶段可以重新绑定到另一个容器。  
   所有物料管理器报告参数均支持自动上传/下载功能。  
2. 单击 **取消**。  


#### 定义设备模块equipment modules  
您可以从单个启用物料的阶段创建多个设备模块。物料规格、物料以及可选的批次和标签在FactoryTalk批次配方编辑器的启用物料阶段步骤中配置。FactoryTalk批次服务器使用此信息查找容器及关联的设备模块以绑定到配方。  

本练习中，您将把两个新容器与现有的NP_ADDNUT_F1和NP_ADDNUT_F2设备模块关联。  
1. 单击 **向上** 按钮返回单元层级。  
2. 双击NP_FREEZER1，显示设备阶段和模块。  
3. 双击NP_ADDNUT_F1，打开“编辑设备模块”对话框并显示“常规”选项卡。  
4. 选择“容器”选项卡，然后展开“容器”文件夹。“容器和存储位置关联”框列出物料数据库中的容器，右侧区域显示与阶段关联的容器。  
5. 选择NUT_BIN3，然后单击 **添加** 按钮。  
6. 为指示此容器向配方添加物料，选中“添加”列中的复选框。  
7. 以相同方式添加NUT_BIN4。  
   现在，NP_ADDNUT_F1设备模块与工厂中存储坚果的四个容器关联。如果这些容器中的任何一个持有与配方中MBR_ADD阶段的物料规格匹配的库存，则设备模块可绑定为将该库存添加到批次的方式。  
8. 单击 **确定**。  
9. 单击 **向上** 按钮。  
10. 将NUT_BIN3和NUT_BIN4以添加进料类型添加到NP_FREEZER2中的NP_ADDNUT_F2设备模块。  
11. 保存ice_cream2.cfg文件，然后退出设备编辑器。如果系统提示输入审核注释，请输入“Updated material containers”，然后单击 **确定**。  


#### 重启FactoryTalk批次服务器  
由于已修改区域模型，必须重启FactoryTalk批次服务器：  
1. 选择 **开始 > Rockwell Software > 批次服务管理器**，打开FactoryTalk批次服务管理器。  
2. **重要提示**：执行此过程需要管理员权限。从“服务”列表中选择FactoryTalk批次服务器。  
3. 单击 **停止** 按钮，等待“服务状态”区域显示“已停止”。  
4. 单击 **启动/继续** 按钮，“服务状态”区域从“已停止”变为“启动挂起”。片刻后显示“正在运行”，指示灯变为绿色。  
5. 单击 **关闭** 关闭FactoryTalk批次服务管理器。  


#### 设置物料容器优先级  
容器优先级定义容器作为绑定特定物料候选的考虑顺序。例如，可能需要先使用存放最久物料的容器，再使用存放较新数量的容器。  

您希望只要NUT_BIN3中有足够物料满足物料需求，就从NUT_BIN3向批次添加榛子。只有当NUT_BIN3中的库存耗尽时，批次才从NUT_BIN4提取。要实现此配置，将NUT_BIN3的优先级设置为比NUT_BIN4更小的数字，以指示NUT_BIN3具有更高优先级。  
1. 启动物料编辑器。  
2. 展开“物料”文件夹，然后双击HAZELNUT，打开“编辑物料”对话框。  
3. 选择“优先级”选项卡，显示添加到区域模型的容器。  
4. 在NUT_BIN3的“优先级”框中输入 **10**。  
5. 在NUT_BIN4的“优先级”框中输入 **20**。  
![material1](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material1.png)
6. 单击 **确定**。  


#### 对启用物料的阶段进行编程  
要维护物料数据库中的库存水平并在批次事件日志中记录库存，编写阶段逻辑时请遵循以下协议：  
- 阶段逻辑必须请求从FactoryTalk批次服务器下载AMOUNT参数。  
- 阶段逻辑必须在进入终端状态（完成、已停止或已中止）之前将ACTUAL_AMOUNT和FEED_COMPLETE报告参数上传到FactoryTalk批次服务器。  

您可以使用FactoryTalk批次中的自动上传/下载功能来满足此协议要求。FactoryTalk批次服务器会在命令设备模块启动前下载AMOUNT参数，并在阶段逻辑运行到终端状态后上传ACTUAL_AMOUNT和FEED_COMPLETE报告参数。  

- ACTUAL_AMOUNT报告参数中的值符号必须与配置的进料类型匹配：添加为正或零，分配为负或零。  



# 基于物料的配方介绍  
一旦定义了物料数据并修改了区域模型，您就可以开始在FactoryTalk Batch配方编辑器中修改主配方。创建基于物料的配方的过程与创建标准配方的过程并无太大差异。实际上，支持物料的阶段步骤是作为标准阶段步骤添加到操作中的。在本章中，您将创建一个新的基于物料的操作，将可可和榛子添加到甜奶油混合物中，这是工厂生产所有冰淇淋的基础。  

### 创建基于物料的操作  
1. 选择 **开始 > Rockwell Software > 配方编辑器**。如果打开“需要验证的配方”对话框，请单击 **取消**。  
2. **重要提示**：执行此过程需要管理员权限。  
   选择 **文件 > 新建顶级New Top Level**。打开“新建”对话框。 
   ![material2](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material2.png) 
3. 选择 **操作Operation**，然后单击 **确定**。打开“单元需求”对话框。
   ![material3](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material3.png)  
   您希望该配方在工艺单元中的两个单元上运行。  
4. 选择 **基于类Class-Based**，选择 **MBR_FREEZER_CLS**，然后单击 **确定**。新操作的初始步骤和最终步骤将显示在顺序功能图 (SFC) 视图中。  
5. 选择初始步骤，然后单击 **添加步骤** 按钮，选择 **MBR_ADD**，然后单击 **确定**。  
6. 单击 **添加并行** 按钮，选择 **RECIRC**，然后单击 **确定**。  
7. 选择最后一个转换，单击 **添加步骤** 按钮，选择 **TEMP_CTL**，然后单击 **确定**。  
8. 单击 **添加并行** 按钮，选择 **RECIRC**，然后单击 **确定**。  
9. 选择最后一个转换，单击 **添加步骤** 按钮，选择 **MBR_ADD**，然后单击 **确定**。  
10. 单击 **添加并行** 按钮，选择 **RECIRC**，然后单击 **确定**。  
11. 选择最后一个转换，单击 **添加步骤** 按钮，选择 **MBR_DUMP**，然后单击 **确定**。 
   ![material4](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material4.png)   
12. 选择 **配方Recipe > 标题数据Header Data**，然后输入以下内容：  
   - 程序标识符：MCLS_CHOCOLATE_HAZELNUT_OP  
   - 作者：您的姓名  
   - 产品名称：CHP-100  
   - 批次大小默认值：5000  
   - 批次大小最大值：10000
   - 度量单位：KG  
   - 估计持续时间：55  
   - 程序描述：巧克力榛子高级冰淇淋  
   ![material5](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material5.png)   
13. 单击 **确定**，然后单击 **继续**。如果系统提示，请根据需要输入审核注释，然后单击 **确定**。  

### 创建配方公式参数  
由于您希望在此配方层级延迟物料的用量，因此需要添加公式参数。您将在程序层级输入默认用量，而操作员在将批次添加到批次列表时将有机会更改用量。  
1. 从 **配方Recipe** 菜单中，选择 **配方参数/报表**。打开“程序属性”对话框。  
2. 单击 **添加参数** 按钮。  
3. 在 **名称** 框中，输入 **COCOA_AMT**。  
4. 在 **最大值** 框中，输入 **500**。  
5. 在 **枚举/工程单位** 框中，输入 **KG**。  
6. 选择 **可缩放**。  
7. 单击 **新建** 按钮，然后添加 **HAZELNUT_AMT**，其值与上述相同。 
   ![material6](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material6.png)   
8. 单击 **确定**。  

### 分配公式值  
对于此配方，您将延迟物料的实际用量并启用自动绑定。  
1. 选择 **MBR_ADD:1**，然后单击 **值输入Value Entry** 按钮。打开“参数值输入/报表限制输入”对话框。  
2. 对于 **数量**，从 **来源** 列表中选择 **延迟**，然后从 **值** 列表中选择 **COCOA_AMT**。  
3. 对于 **物料**，从 **值** 列表中选择 **COCOA**，并启用 **显示**。  
   容器绑定设置为默认的 **自动**。您已在设备编辑器中将进料类型设置为“添加”。  
   ![material7](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material7.png) 
4. 单击 **确定**。SFC 将更新以显示 MBR_ADD:1 的“COCOA 物料”。  
5. 按照下表为其余步骤输入公式参数。其他所有条目使用默认值。 

| 步骤       | 参数       | 来源   | 值                | 显示 |
|------------|------------|--------|-------------------|------|
| RECIRC:1   | RECIRC_RATE | 值     | 50                | 是   |
| TEMP_CTL:1 | HOLD_TIME  | 值     | 5                 | 否   |
|            | TEMP_SP    | 值     | 25                | 是   |
| RECIRC:2   | RECIRC_RATE | 值     | 30                | 是   |
| MBR_ADD:2  | AMOUNT     | 延迟   | HAZELNUT_AMT      | 否   |
|            | MATERIAL   | 值     | HAZELNUT          | 是   |
| RECIRC:3   | RECIRC_RATE | 值     | 20                | 是   |
| MBR_DUMP:1 | AMOUNT     | 值     | -5000             | 是   |
|            | MATERIAL   | 值     | IC_CHOCOLATE_HAZELNUT | 否   |

6. 从 **视图** 菜单中，选择 **表格**。完成的操作应与此类似。
   ![material8](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material8.png)  
7. 从 **视图** 菜单中，选择 **SFC**。  
8. 保存操作。  

### 创建单元程序  
创建巧克力榛子配方的下一步是创建单元程序，该程序将只包含一个操作。  
1. 从 **文件** 菜单中，选择 **新建顶级New Top Level**。打开“新建”对话框。  
2. 选择 **单元程序Unit Procedure**，然后单击 **确定**。打开“单元需求”对话框。  
3. 选择 **基于类**，选择 **MBR_FREEZER_CLS**，然后单击 **确定**。新单元程序的初始步骤和最终步骤将显示在 SFC 视图中。  
4. 选择初始步骤，然后单击 **添加步骤** 按钮。打开“操作选择”对话框。  
5. 选择 **MCLS_CHOCOLATE_HAZELNUT_OP**，然后单击 **确定**。  
   ![material9](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material9.png)  
6. 从 **配方** 菜单中，选择 **配方参数/报表**。打开“程序属性”对话框。按图中所示输入配方公式参数。
   ![material10](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material10.png)  
7. 选择 **MCLS_CHOCOLATE_HAZELNUT_OP**，单击 **公式值** 按钮，然后按图中所示输入公式值。  
   ![material11](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material11.png)
8. 从 **配方** 菜单中，选择 **标题数据**，然后输入以下内容：  
   - 程序标识符：MCLS_CHOCOLATE_HAZELNUT_UP  
   - 作者：您的姓名  
   - 产品名称：CHP-100  
   - 批次大小默认值：5000  
   - 批次大小最大值：10000  
   - 度量单位：KG  
   - 估计持续时间：55  
   - 程序描述：巧克力榛子高级冰淇淋  
   ![material12](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material12.png)
9. 单击 **确定**，然后单击 **继续**。如果系统提示，请根据需要输入审核注释，然后单击 **确定**。  
10. 保存单元程序。如果系统提示，请根据需要输入审核注释，然后单击 **确定**。  

### 启用动态单元分配  
为了支持 NORTH_PARLOR 工艺单元内两个单元的灵活性，您需要启用动态单元分配，这将提供更多绑定选项。  
1. 从 **视图** 菜单中，选择 **选项**。打开“选项”对话框。  
2. 如有必要，启用 **支持动态单元分配**，然后单击 **应用**。  
   ![material13](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material13.png)
3. 保存单元程序。如果系统提示，请根据需要输入审核注释，然后单击 **确定**。 

### 创建程序procedure  
构建配方的最后一步是创建程序。由于已启用动态单元分配，因此必须先定义设备需求和绑定方法，然后才能构建配方程序。  
1. 选择 **文件 > 新建顶级**。打开“新建”对话框。  
   ![material14](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material14.png)
2. 选择 **程序procedure**，然后单击 **确定**。打开“程序 - 单元需求”对话框。
      ![material15](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material15.png)
3. 单击 **添加单元需求** 按钮。打开“添加单元需求”对话框。  
4. 在 **名称** 框中，输入 **FREEZER**。  
   单元需求名称是一个标签，作用类似于 FactoryTalk Batch 服务器的查找表。当配方添加到批次列表且 FactoryTalk Batch 服务器遇到单元需求名称时，服务器会查找映射到该单元需求名称的所有单元类或实例。  
   North_Parlor 有两个可用于生产巧克力榛子冰淇淋的单元。在区域模型中，有两个基于 MBR_MIXER_CLS 单元类的单元实例（NP_MIXER_1 和 NP_MIXER_2）和两个基于 MBR_FREEZER_CLS 单元类的单元实例（NP_FREEZER_1 和 NP_FREEZER2）。您希望操作员在创建批次时选择使用哪个混合器和冷冻机。为此，需要创建一个配置为 MBR_MIXER_CLS 单元类的单元需求名称（MIXER）和一个配置为 MBR_FREEZER_CLS 单元类的单元需求名称（FREEZER）。您还需要选择批次创建绑定方法。  
5. 如果未启用“基于类”部分，请选择 **基于类** 选项。  
6. 从“基于类”区域的 **单元类** 列表中选择 **MBR_FREEZER_CLS**，然后单击 **确定**。  
      ![material16](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material16.png)
7. 从“程序 - 单元需求”对话框中选择 **Alias_MIXER_CLS**，然后单击 **编辑单元需求** 按钮。  
8. 在 **名称** 框中，输入 **MIXER**。  
9. 从“基于类”列表中选择 **MBR_MIXER_CLS**。  
10. 在 **可用下游单元** 框中，选择 **FREEZER**，然后单击向右箭头按钮。  
      ![material17](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material17.png)
11. 单击 **确定**。  
      ![material18](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material18.png)
    当配方添加到批次列表时，FactoryTalk Batch 服务器会遇到 MIXER 单元需求名称（指定配方所需的设备），查找具有 MIXER 单元需求名称的单元类的所有单元实例，然后提示操作员选择 NP_MIXER_1 或 NP_MIXER_2。FREEZER 单元需求名称的处理过程相同。  
12. 单击 **关闭**。  
13. 从 **配方** 菜单中，选择 **标题数据**，然后输入以下内容：  
    - 程序标识符：MCLS_CHOCOLATE_HAZELNUT  
    - 作者：您的姓名  
    - 产品名称：Chocolate Hazelnut Premium  
    - 产品代码：CHP-100  
    - 批次大小最小值：3000  
    - 批次大小默认值：5000  
    - 批次大小最大值：7000  
    - 度量单位：KG  
    - 估计持续时间：55  
    - 程序描述：Chocolate Hazelnut Premium - 基于类/基于物料  

14. 启用 **已发布至生产**，以便在 FactoryTalk Batch 视图中将批次添加到批次列表时显示此配方。
   ![material19](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material19.png)  
15. 单击 **确定**。  
16. 按图中所示输入配方公式参数。  
    这些默认值会在创建批次时提供给操作员。由于公式值是延迟的，操作员可以更改默认值。  
       ![material20](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material20.png) 
17. 选择初始步骤，然后单击 **添加步骤** 按钮。打开“单元程序选择”对话框。  
18. 从 **单元需求名称** 列表中，选择 **MIXER**。  
19. 从 **配方名称** 列表中，选择 **MCLS_SWEETCREAM_UP**，然后单击 **确定**。  
       ![material21](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material21.png) 
20. 以相同方式添加 **MCLS_TRANSFER_OUT_UP**。  
       ![material22](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material22.png) 
    到目前为止，您已将原料放入混合器中以生产冰淇淋的甜奶油基料，并添加了将混合物从混合器中转移出来的步骤。接下来，添加将甜奶油基料转移到冷冻机中的步骤。  
21. 单击 **添加并行** 按钮。打开“单元程序选择”对话框。  
22. 从 **单元需求名称** 列表中，选择 **FREEZER**。 
23. 从 **配方名称** 列表中，选择 **MCLS_TRANSFER_IN_UP**，然后单击 **确定**。  
       ![material23](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material23.png) 
24. 选择最后一个转换，单击 **添加步骤** 按钮，然后添加 **MCLS_CHOCOLATE_HAZELNUT_UP**，并将 **FREEZER** 作为设备需求。  
       ![material24](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material24.png) 
    您的配方应与下图类似。 

           ![material25](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material25.png)  
25. 选择 **MCLS_SWEETCREAM_UP:1**，单击 **公式值** 按钮，按图中所示添加公式值，然后单击 **确定**。  
           ![material26](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material26.png)
26. 选择 **MCLS_CHOCOLATE_HAZELNUT_UP:1**，单击 **公式值** 按钮，然后按图中所示添加公式值。  
    公式值的来源是延迟的，因此当批次添加到批次列表时，参数会显示出来，以便操作员有机会输入值。  
               ![material27](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material27.png)
27. 保存程序。如果系统提示，请根据需要输入审核注释，然后单击 **确定**。  

### 链接阶段组  
使用阶段链接组来标识相互通信和协作的阶段，例如将甜奶油混合物从混合器转移到冷冻机的 XFR_OUT 和 XFR_IN 阶段。在设备编辑器中，XFR_OUT 和 XFR_IN 阶段均配置有一个消息伙伴，这表示这些阶段必须与另一个阶段通信才能正常工作。  

#### 设备编辑器：阶段消息伙伴  
在配方编辑器中，必须在程序层级创建阶段链接组以完成关联。  
1. 在程序层次结构或 SFC 视图中选择 **XFR_IN:1**。  
               ![material28](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material28.png)
2. 从 **链接** 菜单中，选择 **链接组**。打开“阶段链接组”对话框。  
3. 单击 **组1** 列标题以选择“组1”列，然后单击 **添加** 按钮。  
               ![material29](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material29.png)
4. 单击 **确定**。  
5. 单击 **XFR_OUT:1**。  
6. 从 **链接** 菜单中，选择 **链接组**。打开“阶段链接组”对话框。  
7. 选择 **组1** 列，单击 **添加** 按钮，然后单击 **确定**。  
               ![material30](https://raw.githubusercontent.com/kerwenzhang/kerwenzhang.github.io/master/_posts/image/Batch/material30.png)

### 验证配方  
将所有支持物料的阶段添加到配方后，在配方准备运行之前验证配方。  
1. 从 **文件** 菜单中，选择 **验证所有配方**。  
   如果系统提示保存，请单击 **是**。  
2. 验证完成后，单击 **接受**，然后单击 **关闭**。如果系统提示，请根据需要输入审核注释，然后单击 **确定**。  
3. 退出 FactoryTalk Batch 配方编辑器。  

### 总结  
在本章中，您：  
- 创建了基于物料的操作  
- 创建了配方公式参数  
- 分配了公式值  
- 创建了单元程序  
- 链接了阶段组  

本章简要概述了配方编辑器与物料管理器配合使用时的功能。（有关创建基于物料的配方、单元绑定和链接阶段组的更多信息，请参阅《FactoryTalk Batch 配方编辑器用户指南》。）