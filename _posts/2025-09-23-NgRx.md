---                
layout: post                
title: "NgRx学习笔记"                
date:   2025-9-23 18:30:00                 
categories: "Web"                
catalog: true                
tags:                 
    - Web                
---      
在构建复杂的企业级Angular应用时，状态管理成为架构设计的核心挑战。随着应用规模扩大，组件间状态共享、异步操作协同和数据流一致性等问题日益突出。NgRx作为基于Redux模式的响应式状态管理库，已成为Angular生态的状态管理解决方案首选。   

NgRx建立在严格的单向数据流基础上，其核心架构包含五个关键要素：   

1. Store：单一数据源（Single Source of Truth）  
    Store作为不可变的中央状态容器，存储整个应用状态树。在Angular中通过依赖注入使用：  
2. Actions：状态变更描述器  
    Actions是描述状态变更事件的纯对象，使用createAction工厂函数创建：
3. Reducers：状态变更处理器  
Reducers是纯函数，根据Action处理状态转换：  
4. Selectors：状态查询器  
Selectors提供高效的状态查询机制，支持组合和记忆化：  
5. Effects：副作用处理器  
Effects隔离异步操作，保持Reducer纯净：  

1. 生成一个新项目

        ng new my-angular-app --standalone=false --routing --style=css

2. 安装依赖

        npm install @ngrx/store --save    

3. 在app下创建一个名为counter.actions.ts的新文件，以描述增加、减少和重置其值的计数器操作。  

        import { createAction } from '@ngrx/store';

        export const increment = createAction('[Counter Component] Increment');
        export const decrement = createAction('[Counter Component] Decrement');
        export const reset = createAction('[Counter Component] Reset');

4. 在app下创建一个名为counter.reducer.ts的新文件，定义一个 reducer 函数，根据提供的 action 来处理计数器值的变化。  

        import { createReducer, on } from '@ngrx/store';
        import { increment, decrement, reset } from './counter.actions';

        export const initialState = 0;

        export const counterReducer = createReducer(
            initialState,
            on(increment, (state) => state + 1),
            on(decrement, (state) => state - 1),
            on(reset, (state) => 0)
        );

5. 在`app.module.ts`中导入源StoreModule文件@ngrx/store和counter.reducer文件。  

        import { StoreModule } from '@ngrx/store';
        import { counterReducer } from './counter.reducer';

6. 在 AppModule 的 imports 数组中添加 StoreModule.forRoot 函数，并传入一个包含 count 和用于管理计数器状态的 counterReducer 的对象。StoreModule.forRoot() 方法会注册全局的提供者，使整个应用程序都能访问 Store。  

        import { BrowserModule } from '@angular/platform-browser';
        import { NgModule } from '@angular/core';

        import { AppComponent } from './app.component';

        import { StoreModule } from '@ngrx/store';
        import { counterReducer } from './counter.reducer';

        @NgModule({
            declarations: [AppComponent],
            imports: [BrowserModule, StoreModule.forRoot({ count: counterReducer })],
            providers: [],
            bootstrap: [AppComponent],
        })
        export class AppModule {}

7. 在 app 文件夹中创建一个名为 my-counter 的新文件夹，并在其中新建一个名为 my-counter.component.ts 的文件，用于定义一个名为 MyCounterComponent 的新组件。该组件将渲染按钮，允许用户更改计数状态。同时，在同一文件夹中创建一个名为 my-counter.component.html 的文件，用于定义该组件的模板页面。  

        import { Component } from '@angular/core';
        import { Observable } from 'rxjs';

        @Component({
            selector: 'app-my-counter',
            standalone: false,
            templateUrl: './my-counter.component.html',
            styleUrl: './my-counter.component.css'
        })
        export class MyCounterComponent {
            count$: Observable<number>

            constructor() {
                // TODO: Connect `this.count$` stream to the current store `count` state
            }

            increment() {
                // TODO: Dispatch an increment action
            }

            decrement() {
                // TODO: Dispatch a decrement action
            }

            reset() {
                // TODO: Dispatch a reset action
            }
        }

    my-counter.component.html

        <button (click)="increment()">Increment</button>

        <div>Current Count: {{ count$ | async }}</div>

        <button (click)="decrement()">Decrement</button>

        <button (click)="reset()">Reset Counter</button>

8. 将新组件添加到 AppModule 的声明中并在模板app.component.html中声明它：  

        <app-my-counter></app-my-counter>

    app.module.ts

        import { BrowserModule } from '@angular/platform-browser';
        import { NgModule } from '@angular/core';

        import { AppComponent } from './app.component';

        import { StoreModule } from '@ngrx/store';
        import { counterReducer } from './counter.reducer';
        import { MyCounterComponent } from './my-counter/my-counter.component';

        @NgModule({
            declarations: [AppComponent, MyCounterComponent],
            imports: [BrowserModule, StoreModule.forRoot({ count: counterReducer })],
            providers: [],
            bootstrap: [AppComponent],
        })
        export class AppModule {}

9. 将 store 注入到 MyCounterComponent 中，并将 count$ 连接到 store 的 count 状态。通过向 store 分发 action 来实现 increment（递增）、decrement（递减）和 reset（重置）方法。  

        import { Component } from '@angular/core';
        import { Store } from '@ngrx/store';
        import { Observable } from 'rxjs';
        import { decrement, increment, reset } from '../counter.actions';

        @Component({
            selector: 'app-my-counter',
            standalone: false,
            templateUrl: './my-counter.component.html',
            styleUrl: './my-counter.component.css'
        })
        export class MyCounterComponent {
            count$: Observable<number>;

            constructor(private store: Store<{ count: number }>) {
                this.count$ = store.select('count');
            }

            increment() {
                this.store.dispatch(increment());
            }

            decrement() {
                this.store.dispatch(decrement());
            }

            reset() {
                this.store.dispatch(reset());
            }
        }


# Reference
[NgRx](https://ngrx.io/docs)  
[Angular与NgRx状态管理: 最佳实践解析](https://www.jianshu.com/p/7a966d2e791d)